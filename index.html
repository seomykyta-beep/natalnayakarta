<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—Å—Ç—Ä–æ-–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/static/chart.js?v=7"></script>
    <style>
        :root { --bg:#1a1a2e; --card:#16213e; --text:#e0e0e0; --accent:#e94560; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 20px; margin: 0; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; color: #ffd700; margin-bottom: 20px; }
        
        /* Mode Tabs - –ù–∞—Ç–∞–ª/–°–æ–ª—è—Ä/–õ—É–Ω–∞—Ä */
        .mode-tabs { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }
        .mode-tab { 
            padding: 10px 25px; 
            background: transparent; 
            border: none; 
            color: #4fc3f7; 
            font-size: 18px; 
            cursor: pointer; 
            text-decoration: underline; 
            transition: all 0.2s;
        }
        .mode-tab:hover { color: #81d4fa; }
        .mode-tab.active { color: #ffd700; text-decoration: none; font-weight: bold; }

        /* Form Styles */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
        
        .input-group { margin-bottom: 15px; position: relative; }
        label { font-size: 12px; color: #888; display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; background: var(--card); border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        input:focus { border-color: var(--accent); outline: none; }
        
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        
        button { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: opacity 0.2s; }
        button:active { opacity: 0.8; }
        button:disabled { opacity: 0.5; cursor: wait; }
        
        /* Transit/Solar/Lunar Settings Block */
        .settings-block { margin-top: 15px; padding: 15px; border: 1px solid #333; border-radius: 10px; background: rgba(255,255,255,0.02); }
        .settings-block h3 { margin-top: 0; color: #ffd700; font-size: 15px; margin-bottom: 15px; }
        .settings-block.hidden { display: none; }

        /* Results */
        .result-section { display: none; margin-top: 30px; animation: fadeIn 0.5s; }
        
        /* Chart Container - supports dual rings */
        #chartDiv { width: 100%; max-width: 650px; height: 650px; margin: 20px auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        /* View Mode Tabs - –ù–∞—Ç–∞–ª—å–Ω—ã–µ/–¢—Ä–∞–Ω–∑–∏—Ç—ã */
        .view-tabs { display: flex; justify-content: center; margin: 20px 0; background: var(--card); border-radius: 8px; overflow: hidden; max-width: 400px; margin-left: auto; margin-right: auto; }
        .view-tab { 
            flex: 1; 
            padding: 12px 20px; 
            background: transparent; 
            border: none; 
            color: #4fc3f7; 
            font-size: 14px; 
            cursor: pointer; 
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .view-tab:hover { background: rgba(255,255,255,0.05); }
        .view-tab.active { background: rgba(79,195,247,0.15); color: #4fc3f7; border-bottom: 3px solid #4fc3f7; font-weight: bold; }

        /* SCHEMES STYLES */
        .schemes-container { display: flex; flex-direction: column; gap: 20px; justify-content: center; margin-bottom: 30px; }
        .scheme-box { background: var(--card); padding: 15px; border-radius: 10px; width: 100%; }
        .scheme-box.full-width { width: 100%; }
        
        /* Planet Table */
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th, .data-table td { padding: 8px; text-align: left; border-bottom: 1px solid #333; }
        .data-table th { color: #888; font-weight: normal; }
        .data-table td:first-child { font-weight: bold; color: #ffd700; }
        .transit-cell { color: #ff7575; text-align: center; }
        
        /* Aspect Matrix */
        .aspect-matrix-wrapper { overflow: auto; margin-top: 10px; width: 100%; }
        .aspect-matrix-table { border-collapse: collapse; width: 100%; min-width: 100%; background: #0f1424; }
        .aspect-matrix-table th,
        .aspect-matrix-table td { border: 1px solid #333; width: 32px; height: 32px; text-align: center; font-size: 12px; color: #ddd; }
        .aspect-matrix-table th { background: #1f1f35; font-weight: normal; }
        .matrix-icon { font-size: 16px; color: #ffd700; display: block; }
        .matrix-symbol { font-size: 15px; font-weight: bold; display: block; }
        .matrix-empty { background: rgba(255,255,255,0.02); }
        .asp-conj { color: #4fc3f7; }
        .asp-sextile { color: #00c853; }
        .asp-square { color: #ff5555; }
        .asp-trine { color: #d4e157; }
        .asp-opposition { color: #ff9100; }
        .asp-quincunx { color: #26c6da; }
        .aspect-legend { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; font-size: 12px; color: #bbb; margin-top: 15px; }
        .aspect-legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-symbol { font-weight: bold; font-size: 14px; }
        .legend-retro { color: #ff5555; }
        .transit-meta { text-align: center; color: #bbb; font-size: 12px; margin-top: 8px; }

        /* Afetics (Planet Strength) */
        .afetic-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 6px; }
        .afetic-positive { background: #1b5e20; color: #a5d6a7; }
        .afetic-negative { background: #b71c1c; color: #ef9a9a; }
        .afetic-neutral { background: #37474f; color: #90a4ae; }
        .dignity-badge { font-size: 10px; color: #ffd54f; margin-left: 4px; }
        
        /* Interactive Aspects */
        .aspect-highlight { background: rgba(255,215,0,0.15) !important; }
        .planet-highlight { color: #ffd700 !important; text-shadow: 0 0 8px #ffd700; }

        /* Texts */
        .text-section { margin-top: 40px; }
        .planet-text-block { background: var(--card); padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid var(--accent); }
        .planet-text-header { font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #ffd700; display: flex; align-items: center; }
        .planet-text-header span { margin-right: 10px; font-size: 20px; }
        .planet-text-body { font-size: 14px; line-height: 1.6; color: #ddd; white-space: pre-wrap; }

        /* Suggestions */
        .suggestions { position: absolute; background: #222; width: 100%; max-height: 200px; overflow-y: auto; z-index: 100; border: 1px solid #444; border-radius: 0 0 8px 8px; display: none; top: 100%; }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; }
        .suggestion-item:hover { background: #333; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .error-msg { color: #ff4444; text-align: center; margin-top: 10px; display: none; }

        /* Info text */
        .info-text { text-align: center; color: #888; font-size: 13px; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåå –ù–∞—Ç–∞–ª—å–Ω–∞—è –ö–∞—Ä—Ç–∞</h1>
        
        <!-- Mode Tabs: –ù–∞—Ç–∞–ª / –°–æ–ª—è—Ä / –õ—É–Ω–∞—Ä -->
        <div class="mode-tabs">
            <button class="mode-tab active" data-mode="natal" onclick="setMode('natal')">–ù–∞—Ç–∞–ª</button>
            <button class="mode-tab" data-mode="solar" onclick="setMode('solar')">–°–æ–ª—è—Ä</button>
            <button class="mode-tab" data-mode="lunar" onclick="setMode('lunar')">–õ—É–Ω–∞—Ä</button>
        </div>

        <div id="form">
            <!-- Basic Birth Data -->
            <div class="form-grid">
                <div class="input-group"><label>–ò–º—è</label><input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è" value="–ü–∞–≤–µ–ª"></div>
                <div class="input-group">
                    <label>–ü–æ–ª</label>
                    <div class="row" style="gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: white;">
                            <input type="radio" name="gender" value="male" checked style="width: auto; margin: 0;"> ‚ôÇ –ú—É–∂—Å–∫–æ–π
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: white;">
                            <input type="radio" name="gender" value="female" style="width: auto; margin: 0;"> ‚ôÄ –ñ–µ–Ω—Å–∫–∏–π
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="form-grid">
                <div>
                    <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <div class="row">
                        <input type="number" id="day" placeholder="–î–î" class="col" value="1">
                        <input type="number" id="month" placeholder="–ú–ú" class="col" value="5">
                        <input type="number" id="year" placeholder="–ì–ì–ì–ì" class="col" style="flex: 1.5;" value="1997">
                    </div>
                </div>
                <div>
                    <label>–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <div class="row">
                        <input type="number" id="hour" placeholder="–ß–ß" class="col" value="12">
                        <input type="number" id="minute" placeholder="–ú–ú" class="col" value="0">
                    </div>
                </div>
            </div>

            <div class="input-group" style="margin-top: 15px;">
                <label>–ì–æ—Ä–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                <input type="text" id="city" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å..." oninput="suggestCity()" autocomplete="off" value="–ú–æ—Å–∫–≤–∞">
                <div class="suggestions" id="suggestions"></div>
                <input type="hidden" id="lat" value="55.7558"><input type="hidden" id="lon" value="37.6173">
            </div>

            <!-- Transit Settings (for Natal mode with transits) -->
            <div id="transitSettings" class="settings-block">
                <h3>üìÖ –¢—Ä–∞–Ω–∑–∏—Ç—ã –ø–ª–∞–Ω–µ—Ç –Ω–∞ –¥–∞—Ç—É</h3>
                <div class="form-grid">
                    <div>
                        <label>–î–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∏—Ç–∞</label>
                        <div class="row">
                            <input type="number" id="t_day" placeholder="–î–î" class="col">
                            <input type="number" id="t_month" placeholder="–ú–ú" class="col">
                            <input type="number" id="t_year" placeholder="–ì–ì–ì–ì" class="col" style="flex: 1.5;">
                        </div>
                    </div>
                    <div>
                        <label>–í—Ä–µ–º—è —Ç—Ä–∞–Ω–∑–∏—Ç–∞</label>
                        <div class="row">
                            <input type="number" id="t_hour" placeholder="–ß–ß" class="col">
                            <input type="number" id="t_minute" placeholder="–ú–ú" class="col">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Solar Settings -->
            <div id="solarSettings" class="settings-block hidden">
                <h3>‚òÄÔ∏è –°–æ–ª—è—Ä (–°–æ–ª–Ω–µ—á–Ω–æ–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ)</h3>
                <p class="info-text">–ö–∞—Ä—Ç–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –°–æ–ª–Ω—Ü–∞ –≤ –Ω–∞—Ç–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é</p>
                <div class="form-grid">
                    <div>
                        <label>–ì–æ–¥ —Å–æ–ª—è—Ä–∞</label>
                        <input type="number" id="solar_year" placeholder="–ì–ì–ì–ì" class="col">
                    </div>
                    <div class="input-group">
                        <label>–ì–æ—Ä–æ–¥ (–≥–¥–µ –±—É–¥–µ—Ç–µ –≤ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è)</label>
                        <input type="text" id="solar_city" placeholder="–ì–æ—Ä–æ–¥ –¥–ª—è —Å–æ–ª—è—Ä–∞" oninput="suggestSolarCity()" autocomplete="off">
                        <div class="suggestions" id="solarSuggestions"></div>
                        <input type="hidden" id="solar_lat"><input type="hidden" id="solar_lon">
                    </div>
                </div>
            </div>

            <!-- Lunar Settings -->
            <div id="lunarSettings" class="settings-block hidden">
                <h3>üåô –õ—É–Ω–∞—Ä (–õ—É–Ω–Ω–æ–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ)</h3>
                <p class="info-text">–ö–∞—Ä—Ç–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –õ—É–Ω—ã –≤ –Ω–∞—Ç–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é</p>
                <div class="form-grid">
                    <div>
                        <label>–ú–µ—Å—è—Ü –ª—É–Ω–∞—Ä–∞</label>
                        <div class="row">
                            <input type="number" id="lunar_month" placeholder="–ú–ú" class="col">
                            <input type="number" id="lunar_year" placeholder="–ì–ì–ì–ì" class="col" style="flex: 1.5;">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>–ì–æ—Ä–æ–¥</label>
                        <input type="text" id="lunar_city" placeholder="–ì–æ—Ä–æ–¥ –¥–ª—è –ª—É–Ω–∞—Ä–∞" oninput="suggestLunarCity()" autocomplete="off">
                        <div class="suggestions" id="lunarSuggestions"></div>
                        <input type="hidden" id="lunar_lat"><input type="hidden" id="lunar_lon">
                    </div>
                </div>
            </div>
            
            <button onclick="calculate()" id="calcBtn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–∞—Ä—Ç—É</button>
            <div id="errorMsg" class="error-msg"></div>
        </div>

        <!-- RESULTS -->
        <div id="result" class="result-section">
            <h2 style="text-align:center">–ö–∞—Ä—Ç–∞ –¥–ª—è: <span id="resName" style="color: var(--accent)"></span></h2>
            <div style="text-align: center; color: #888; font-size: 14px; margin-bottom: 10px;">
                <span id="resCity"></span> ‚Ä¢ <span id="resTime"></span>
            </div>
            <div id="resMode" style="text-align: center; color: #4fc3f7; font-size: 13px; margin-bottom: 20px;"></div>

            <!-- View Tabs: –ù–∞—Ç–∞–ª—å–Ω—ã–µ / –¢—Ä–∞–Ω–∑–∏—Ç—ã -->
            <div class="view-tabs" id="viewTabs">
                <button class="view-tab active" data-view="natal" onclick="setView('natal')">–ù–∞—Ç–∞–ª—å–Ω—ã–µ</button>
                <button class="view-tab" data-view="transit" onclick="setView('transit')">–¢—Ä–∞–Ω–∑–∏—Ç—ã</button>
            </div>

            <!-- 1. CHART VISUAL -->
            <div id="chartDiv"></div>
            
            <!-- 2. SCHEMES (TABLES) -->
            <div class="schemes-container">
                <!-- Aspects Matrix -->
                <div class="scheme-box full-width">
                    <h3 style="text-align:center; margin-top:0">‚ú® <span id="matrixTitle">–ú–∞—Ç—Ä–∏—Ü–∞ –∞—Å–ø–µ–∫—Ç–æ–≤</span></h3>
                    <div class="aspect-matrix-wrapper">
                        <table id="aspectMatrixTable" class="aspect-matrix-table"></table>
                    </div>
                    <div id="transitMeta" class="transit-meta"></div>
                    <div class="aspect-legend">
                        <div class="aspect-legend-item"><span class="legend-symbol asp-conj">‚óè</span>- –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ 0¬∞ (–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π)</div>
                        <div class="aspect-legend-item"><span class="legend-symbol asp-sextile">‚ú∂</span>- –°–µ–∫—Å—Ç–∏–ª—å 60¬∞ (–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π)</div>
                        <div class="aspect-legend-item"><span class="legend-symbol asp-trine">‚ñ≥</span>- –¢—Ä–∏–≥–æ–Ω 120¬∞ (–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π)</div>
                        <div class="aspect-legend-item"><span class="legend-symbol asp-quincunx">‚§ª</span>- –ö–≤–∏–Ω–∫–æ–Ω—Å 150¬∞ (–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π)</div>
                        <div class="aspect-legend-item"><span class="legend-symbol asp-square">‚ñ°</span>- –ö–≤–∞–¥—Ä–∞—Ç 90¬∞ (–ù–∞–ø—Ä—è–∂—ë–Ω–Ω—ã–π)</div>
                        <div class="aspect-legend-item"><span class="legend-symbol asp-opposition">‚òç</span>- –û–ø–ø–æ–∑–∏—Ü–∏—è 180¬∞ (–ù–∞–ø—Ä—è–∂—ë–Ω–Ω—ã–π)</div>
                        <div class="aspect-legend-item"><span class="legend-symbol legend-retro">R</span>- –†–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω—ã–π</div>
                    </div>
                </div>

                <!-- Planets Table with Afetics -->
                <div class="scheme-box">
                    <h3 style="text-align:center; margin-top:0">ü™ê –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –°–∏–ª–∞ –ø–ª–∞–Ω–µ—Ç</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–ü–ª–∞–Ω–µ—Ç—ã</th>
                                <th>–ù–∞—Ç–∞–ª—å–Ω–∞—è –¥–æ–ª–≥–æ—Ç–∞</th>
                                <th id="transitColHeader">–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–æ–ª–≥–æ—Ç–∞</th>
                                <th style="text-align:center">–°–∏–ª–∞</th>
                            </tr>
                        </thead>
                        <tbody id="planetsTableBody"></tbody>
                    </table>
                    <div style="margin-top: 10px; font-size: 11px; color: #888;">
                        <b>–°–∏–ª–∞:</b> –ë–∞–ª–ª—ã –∞—Ñ–µ—Ç–∏–∫–∏ (–¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞ + –¥–æ–º–∞ + –∞—Å–ø–µ–∫—Ç—ã). 
                        <span style="color:#a5d6a7">–ó–µ–ª–µ–Ω—ã–π</span> = —Å–∏–ª—å–Ω–∞—è, 
                        <span style="color:#ef9a9a">–∫—Ä–∞—Å–Ω—ã–π</span> = —Å–ª–∞–±–∞—è.
                    </div>
                </div>
            </div>
            
            <!-- 3. TEXTS -->
            <div class="text-section">
                <h3 style="text-align:center; margin-bottom:30px;">üìñ –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</h3>
                <div id="textsList"></div>
            </div>
            
            <button onclick="downloadPDF()" style="background: #444; margin-bottom: 50px; margin-top: 30px;">üìÑ –°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç</button>
        </div>
    </div>

    <script>
        // === STATE ===
        let currentMode = 'natal';  // natal, solar, lunar
        let currentView = 'natal';  // natal, transit (for aspect matrix)
        let globalData = null;      // Store calculation result

        // === MODE SWITCHING ===
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.mode-tab[data-mode="${mode}"]`).classList.add('active');

            // Show/hide settings blocks
            document.getElementById('transitSettings').classList.toggle('hidden', mode !== 'natal');
            document.getElementById('solarSettings').classList.toggle('hidden', mode !== 'solar');
            document.getElementById('lunarSettings').classList.toggle('hidden', mode !== 'lunar');

            // Update button text
            const btn = document.getElementById('calcBtn');
            if (mode === 'natal') btn.textContent = '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–∞—Ä—Ç—É';
            else if (mode === 'solar') btn.textContent = '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–æ–ª—è—Ä';
            else if (mode === 'lunar') btn.textContent = '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ª—É–Ω–∞—Ä';
        }

        // === VIEW SWITCHING (Natal aspects / Transit aspects) ===
        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.view-tab[data-view="${view}"]`).classList.add('active');

            if (globalData) {
                updateMatrixAndChart(view);
            }
        }

        function updateMatrixAndChart(view) {
            const data = globalData;
            if (!data) return;

            const matrixTitle = document.getElementById('matrixTitle');
            const transitMeta = document.getElementById('transitMeta');
            const transitColHeader = document.getElementById('transitColHeader');

            if (view === 'natal') {
                matrixTitle.textContent = '–ù–∞—Ç–∞–ª—å–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã';
                transitMeta.textContent = '';
                transitColHeader.textContent = currentMode === 'natal' ? '–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–æ–ª–≥–æ—Ç–∞' : 
                                               currentMode === 'solar' ? '–°–æ–ª—è—Ä' : '–õ—É–Ω–∞—Ä';
                // Render natal-only matrix
                renderAspectMatrix(data.planets, data.planets, data.aspects, false);
                // Draw natal-only chart
                drawChart(data.planets, data.houses, data.aspects, null);
            } else {
                // Transit view
                const outerPlanets = data.transits || data.outer_planets || [];
                const transitAspects = data.transit_aspects || [];
                
                if (outerPlanets.length > 0) {
                    matrixTitle.textContent = currentMode === 'natal' ? '–¢—Ä–∞–Ω–∑–∏—Ç ‚Üî –ù–∞—Ç–∞–ª' :
                                              currentMode === 'solar' ? '–°–æ–ª—è—Ä ‚Üî –ù–∞—Ç–∞–ª' : '–õ—É–Ω–∞—Ä ‚Üî –ù–∞—Ç–∞–ª';
                    if (data.transit_meta) {
                        transitMeta.textContent = `–ù–∞ ${data.transit_meta.dt}`;
                    } else if (data.outer_meta) {
                        transitMeta.textContent = `${data.outer_meta.dt}`;
                    }
                    transitColHeader.textContent = currentMode === 'natal' ? '–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–æ–ª–≥–æ—Ç–∞' : 
                                                   currentMode === 'solar' ? '–°–æ–ª—è—Ä' : '–õ—É–Ω–∞—Ä';
                    // Render transit matrix (natal rows vs transit cols)
                    renderAspectMatrix(data.planets, outerPlanets, transitAspects, true);
                    // Draw dual chart
                    drawChart(data.planets, data.houses, data.aspects, outerPlanets);
                } else {
                    matrixTitle.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∏—Ç–æ–≤';
                    transitMeta.textContent = '';
                }
            }
        }

        // === INIT ===
        window.addEventListener('load', () => {
            setDefaultTransitFields();
            setDefaultSolarFields();
            setDefaultLunarFields();
        });

        function setDefaultTransitFields() {
            const now = new Date();
            document.getElementById('t_day').value = now.getDate();
            document.getElementById('t_month').value = now.getMonth() + 1;
            document.getElementById('t_year').value = now.getFullYear();
            document.getElementById('t_hour').value = now.getHours();
            document.getElementById('t_minute').value = now.getMinutes();
        }

        function setDefaultSolarFields() {
            const now = new Date();
            document.getElementById('solar_year').value = now.getFullYear();
            document.getElementById('solar_city').value = document.getElementById('city').value;
        }

        function setDefaultLunarFields() {
            const now = new Date();
            document.getElementById('lunar_month').value = now.getMonth() + 1;
            document.getElementById('lunar_year').value = now.getFullYear();
            document.getElementById('lunar_city').value = document.getElementById('city').value;
        }

        // Auto-focus logic
        ['day', 'month', 'year', 'hour', 'minute'].forEach((id, i, arr) => {
            document.getElementById(id).addEventListener('input', function() {
                if(this.value.length >= this.getAttribute('placeholder').length && i < arr.length-1) {
                    document.getElementById(arr[i+1]).focus();
                }
            });
        });

        // === CITY SEARCH ===
        let timer;
        function suggestCity() { _suggestCity('city', 'suggestions', 'lat', 'lon'); }
        function suggestSolarCity() { _suggestCity('solar_city', 'solarSuggestions', 'solar_lat', 'solar_lon'); }
        function suggestLunarCity() { _suggestCity('lunar_city', 'lunarSuggestions', 'lunar_lat', 'lunar_lon'); }

        function _suggestCity(inputId, listId, latId, lonId) {
            clearTimeout(timer);
            const val = document.getElementById(inputId).value;
            const list = document.getElementById(listId);
            if(val.length < 3) { list.style.display='none'; return; }
            
            timer = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&accept_language=ru`);
                    const data = await res.json();
                    list.innerHTML = '';
                    if(data.length) {
                        list.style.display = 'block';
                        data.slice(0, 5).forEach(p => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.textContent = p.display_name.split(',').slice(0,3).join(', ');
                            div.onclick = () => {
                                document.getElementById(inputId).value = p.display_name.split(',')[0];
                                document.getElementById(latId).value = p.lat;
                                document.getElementById(lonId).value = p.lon;
                                list.style.display = 'none';
                            }
                            list.appendChild(div);
                        });
                    }
                } catch(e) { console.error(e); }
            }, 500);
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-group')) {
                document.querySelectorAll('.suggestions').forEach(s => s.style.display = 'none');
            }
        });

        // === MAIN CALCULATION ===
        async function calculate() {
            const btn = document.getElementById('calcBtn');
            const errorDiv = document.getElementById('errorMsg');
            
            btn.innerHTML = "‚è≥ –í—ã—á–∏—Å–ª—è—é...";
            btn.disabled = true;
            errorDiv.style.display = 'none';
            document.getElementById('result').style.display = 'none';
            
            const genderRadio = document.querySelector('input[name="gender"]:checked');
            const baseData = {
                name: document.getElementById('name').value || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                gender: genderRadio ? genderRadio.value : "male",
                year: parseInt(document.getElementById('year').value),
                month: parseInt(document.getElementById('month').value),
                day: parseInt(document.getElementById('day').value),
                hour: parseInt(document.getElementById('hour').value),
                minute: parseInt(document.getElementById('minute').value),
                city: document.getElementById('city').value,
                lat: parseFloat(document.getElementById('lat').value) || null,
                lon: parseFloat(document.getElementById('lon').value) || null,
                mode: currentMode
            };

            // Add mode-specific data
            if (currentMode === 'natal') {
                baseData.transit_year = parseInt(document.getElementById('t_year').value);
                baseData.transit_month = parseInt(document.getElementById('t_month').value);
                baseData.transit_day = parseInt(document.getElementById('t_day').value);
                baseData.transit_hour = parseInt(document.getElementById('t_hour').value);
                baseData.transit_minute = parseInt(document.getElementById('t_minute').value);
            } else if (currentMode === 'solar') {
                baseData.solar_year = parseInt(document.getElementById('solar_year').value);
                baseData.solar_city = document.getElementById('solar_city').value;
                baseData.solar_lat = parseFloat(document.getElementById('solar_lat').value) || baseData.lat;
                baseData.solar_lon = parseFloat(document.getElementById('solar_lon').value) || baseData.lon;
            } else if (currentMode === 'lunar') {
                baseData.lunar_month = parseInt(document.getElementById('lunar_month').value);
                baseData.lunar_year = parseInt(document.getElementById('lunar_year').value);
                baseData.lunar_city = document.getElementById('lunar_city').value;
                baseData.lunar_lat = parseFloat(document.getElementById('lunar_lat').value) || baseData.lat;
                baseData.lunar_lon = parseFloat(document.getElementById('lunar_lon').value) || baseData.lon;
            }

            try {
                const res = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(baseData)
                });
                const result = await res.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }

                globalData = result;
                renderResult(result);
            } catch (e) {
                errorDiv.textContent = "–û—à–∏–±–∫–∞: " + e.message;
                errorDiv.style.display = 'block';
            } finally {
                btn.innerHTML = currentMode === 'natal' ? "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–∞—Ä—Ç—É" :
                               currentMode === 'solar' ? "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–æ–ª—è—Ä" : "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ª—É–Ω–∞—Ä";
                btn.disabled = false;
            }
        }

        function renderResult(data) {
            document.getElementById('result').style.display = 'block';
            document.getElementById('resName').textContent = data.name;
            document.getElementById('resCity').textContent = data.meta.city;
            document.getElementById('resTime').textContent = data.meta.dt;
            
            // Mode info
            const modeInfo = document.getElementById('resMode');
            if (currentMode === 'natal') {
                modeInfo.textContent = '–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞';
            } else if (currentMode === 'solar') {
                modeInfo.textContent = `–°–æ–ª—è—Ä –Ω–∞ ${data.outer_meta?.dt || '–≥–æ–¥'}`;
            } else {
                modeInfo.textContent = `–õ—É–Ω–∞—Ä –Ω–∞ ${data.outer_meta?.dt || '–º–µ—Å—è—Ü'}`;
            }

            // Show/hide view tabs based on mode and data
            const viewTabs = document.getElementById('viewTabs');
            const hasOuter = (data.transits && data.transits.length > 0) || 
                            (data.outer_planets && data.outer_planets.length > 0);
            viewTabs.style.display = hasOuter ? 'flex' : 'none';
            
            // Reset to natal view
            currentView = 'natal';
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.view-tab[data-view="natal"]').classList.add('active');

            // 1. Planets Table
            renderPlanetsTable(data);

            // 2. Initial matrix (natal aspects)
            updateMatrixAndChart('natal');

            // 3. Text descriptions
            renderTexts(data);
            
            setTimeout(() => {
                document.getElementById('result').scrollIntoView({behavior: 'smooth'});
            }, 100);
        }

        function renderPlanetsTable(data) {
            const tBody = document.getElementById('planetsTableBody');
            tBody.innerHTML = '';

            const outerPlanets = data.transits || data.outer_planets || [];
            const outerMap = {};
            outerPlanets.forEach(p => { if (p.key) outerMap[p.key] = p; });

            const formatPos = (planet) => {
                if (!planet) return '‚Äî';
                const deg = Math.floor(planet.pos);
                const min = Math.round((planet.pos % 1) * 60);
                return `${planet.sign} ${deg}¬∞${min.toString().padStart(2,'0')}'`;
            };

            data.planets.forEach(p => {
                const retro = p.is_retro ? '<span style="color:red; font-size:10px; vertical-align:super;">R</span>' : '';
                const outerP = outerMap[p.key];
                const outerRetro = outerP?.is_retro ? '<span style="color:red; font-size:10px; vertical-align:super;">R</span>' : '';
                
                let afeticHtml = '';
                if (p.afetic_score !== undefined && p.key !== 'ASC' && p.key !== 'MC') {
                    const score = p.afetic_score;
                    let badgeClass = 'afetic-neutral';
                    if (score >= 3) badgeClass = 'afetic-positive';
                    else if (score <= -3) badgeClass = 'afetic-negative';
                    afeticHtml = `<span class="afetic-badge ${badgeClass}">${score > 0 ? '+' : ''}${score}</span>`;
                    if (p.dignity) {
                        afeticHtml += `<span class="dignity-badge">${p.dignity}</span>`;
                    }
                }
                
                tBody.innerHTML += `
                    <tr class="planet-row" data-planet="${p.key}">
                        <td style="color:${p.key==='ASC'||p.key==='MC'?'#ff5555':'#ffd700'}; display:flex; align-items:center; gap:8px;">
                            <span>${p.icon}</span><span>${p.name} ${retro}</span>
                        </td>
                        <td>${formatPos(p)}</td>
                        <td class="transit-cell">${outerP ? formatPos(outerP) + outerRetro : '‚Äî'}</td>
                        <td style="text-align:center">${afeticHtml}</td>
                    </tr>`;
            });
        }

        function renderTexts(data) {
            const textContainer = document.getElementById('textsList');
            textContainer.innerHTML = '';

            // Planet texts
            data.planets.forEach(p => {
                if(p.text && p.key !== 'ASC' && p.key !== 'MC') {
                    textContainer.innerHTML += `
                        <div class="planet-text-block">
                            <div class="planet-text-header">
                                <span>${p.icon}</span> ${p.name} –≤ –∑–Ω–∞–∫–µ ${p.sign}, ${p.house} –¥–æ–º
                            </div>
                            <div class="planet-text-body">${p.text}</div>
                        </div>`;
                }
            });

            // Aspect texts (natal)
            data.aspects.forEach(a => {
                let color = "#ccc";
                if (a.type === "Square" || a.type === "Opposition") color = "#ff5555";
                if (a.type === "Trine") color = "#8bc34a";
                if (a.type === "Sextile") color = "#4dd0e1";
                if (a.type === "Quincunx") color = "#26c6da";
                
                let symbol = "‚óè";
                if(a.type === "Conjunction") symbol = "‚òå";
                if(a.type === "Sextile") symbol = "‚ú∂";
                if(a.type === "Square") symbol = "‚ñ°";
                if(a.type === "Trine") symbol = "‚ñ≥";
                if(a.type === "Opposition") symbol = "‚òç";
                if(a.type === "Quincunx") symbol = "‚§ª";

                textContainer.innerHTML += `
                    <div class="planet-text-block" style="border-left-color: ${color}">
                        <div class="planet-text-header">
                            <span style="color:${color}">${symbol}</span> ${a.p1} ‚Äî ${a.p2} (${a.name || a.type})
                        </div>
                        <div class="planet-text-body">${a.text || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                    </div>`;
            });
        }

        // === CHART DRAWING ===
        function drawChart(planets, cusps, aspects, outerPlanets) {
            const container = document.getElementById('chartDiv');
            const size = Math.min(container.clientWidth, 650) || 500;
            container.style.height = size + "px";

            const chart = new NatalChart('chartDiv', size);
            chart.draw({
                planets: planets,
                houses: cusps,
                aspects: aspects,
                outerPlanets: outerPlanets  // For dual ring
            });
        }

        // === ASPECT MATRIX ===
        function renderAspectMatrix(natalPlanets, outerPlanets, aspects, isTransitMode) {
            const table = document.getElementById('aspectMatrixTable');
            if (!table) return;
            table.innerHTML = '';

            const planetsOrder = [
                { key: 'Sun', icon: '‚òâ' },
                { key: 'Moon', icon: '‚òæ' },
                { key: 'Mercury', icon: '‚òø' },
                { key: 'Venus', icon: '‚ôÄ' },
                { key: 'Mars', icon: '‚ôÇ' },
                { key: 'Jupiter', icon: '‚ôÉ' },
                { key: 'Saturn', icon: '‚ôÑ' },
                { key: 'Uranus', icon: '‚ôÖ' },
                { key: 'Neptune', icon: '‚ôÜ' },
                { key: 'Pluto', icon: '‚ôá' },
                { key: 'Lilith', icon: '‚ö∏' },
                { key: 'North_node', icon: '‚òä' },
                { key: 'South_node', icon: '‚òã' },
                { key: 'ASC', icon: 'AC' },
                { key: 'MC', icon: 'MC' }
            ];

            const natalMap = {};
            natalPlanets.forEach(p => { if (p.key) natalMap[p.key] = p; });
            const outerMap = {};
            outerPlanets.forEach(p => { if (p.key) outerMap[p.key] = p; });

            const aspectMap = {};
            aspects.forEach(a => {
                if (a.p1_key && a.p2_key) {
                    aspectMap[`${a.p1_key}_${a.p2_key}`] = a;
                    aspectMap[`${a.p2_key}_${a.p1_key}`] = a;  // Both directions
                }
            });

            const symbols = {
                Conjunction: { char: '‚óè', cls: 'asp-conj' },
                Sextile: { char: '‚ú∂', cls: 'asp-sextile' },
                Square: { char: '‚ñ°', cls: 'asp-square' },
                Trine: { char: '‚ñ≥', cls: 'asp-trine' },
                Opposition: { char: '‚òç', cls: 'asp-opposition' },
                Quincunx: { char: '‚§ª', cls: 'asp-quincunx' }
            };

            // Header row (outer planets / columns)
            const headerRow = document.createElement('tr');
            const cornerTh = document.createElement('th');
            cornerTh.textContent = isTransitMode ? '‚Üì–ù–∞—Ç / –¢—Ä‚Üí' : '‚Üì/‚Üí';
            cornerTh.style.fontSize = '9px';
            headerRow.appendChild(cornerTh);

            planetsOrder.forEach(pl => {
                const th = document.createElement('th');
                th.innerHTML = `<span class="matrix-icon">${pl.icon}</span>`;
                th.dataset.planet = pl.key;
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            // Data rows (natal planets)
            planetsOrder.forEach(rowPl => {
                const tr = document.createElement('tr');
                const header = document.createElement('th');
                header.innerHTML = `<span class="matrix-icon">${rowPl.icon}</span>`;
                tr.appendChild(header);

                planetsOrder.forEach((colPl, colIdx) => {
                    const td = document.createElement('td');
                    
                    if (!isTransitMode) {
                        // Natal-only mode: triangular matrix (below diagonal)
                        const rowIdx = planetsOrder.findIndex(p => p.key === rowPl.key);
                        if (colIdx >= rowIdx) {
                            td.classList.add('matrix-empty');
                        } else {
                            const aspectKey = `${rowPl.key}_${colPl.key}`;
                            const aspect = aspectMap[aspectKey];
                            if (aspect) {
                                const sym = symbols[aspect.type] || symbols.Conjunction;
                                td.innerHTML = `<span class="matrix-symbol ${sym.cls}">${sym.char}</span>`;
                                td.title = `${aspect.p1} ${aspect.name} ${aspect.p2} (${aspect.orb}¬∞)`;
                            } else {
                                td.classList.add('matrix-empty');
                            }
                        }
                    } else {
                        // Transit mode: full matrix (natal rows vs outer cols)
                        const natalP = natalMap[rowPl.key];
                        const outerP = outerMap[colPl.key];
                        if (!natalP || !outerP) {
                            td.classList.add('matrix-empty');
                        } else {
                            const aspectKey = `${natalP.key}_${outerP.key}`;
                            const aspect = aspectMap[aspectKey];
                            if (aspect) {
                                const sym = symbols[aspect.type] || symbols.Conjunction;
                                td.innerHTML = `<span class="matrix-symbol ${sym.cls}">${sym.char}</span>`;
                                td.title = `${aspect.p1} ${aspect.name} ${aspect.p2} (${aspect.orb}¬∞)`;
                            } else {
                                td.classList.add('matrix-empty');
                            }
                        }
                    }
                    tr.appendChild(td);
                });

                table.appendChild(tr);
            });
        }

        // === PDF DOWNLOAD ===
        function downloadPDF() {
            const name = document.getElementById('name').value;
            const btn = event.target;
            btn.innerHTML = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
            
            const link = document.createElement('a');
            link.href = `/api/pdf?name=${encodeURIComponent(name)}`;
            link.download = `Horoscope_${name}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            setTimeout(() => btn.innerHTML = "üìÑ –°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç", 2000);
        }

        // Init Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }
    </script>
</body>
</html>

