<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–∞–Ω–∑–∏—Ç—ã. –û–Ω–ª–∞–π–Ω —Ä–∞—Å—á–µ—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/static/chart.js?v=10"></script>
    <style>
        :root {
            --bg: #000;
            --card: rgba(29, 29, 31, 0.8);
            --text: #f5f5f7;
            --text-secondary: #86868b;
            --accent: #bf5af2;
            --accent-2: #5e5ce6;
            --border: rgba(255,255,255,0.08);
            --input-bg: rgba(0,0,0,0.4);
        }

        :root { --blue: var(--accent); }

        :root[data-theme="transit"] { --accent: #06d6a0; --accent-2: #118ab2; }
        :root[data-theme="natal"] { --accent: #bf5af2; --accent-2: #5e5ce6; }
        :root[data-theme="solar"] { --accent: #ffd60a; --accent-2: #ff9500; }
        :root[data-theme="lunar"] { --accent: #a8dadc; --accent-2: #457b9d; }
        :root[data-theme="synastry"] { --accent: #e91e63; --accent-2: #9c27b0; }
        
        * { box-sizing: border-box; }
        
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 40px 24px;
        }
        
        h1 {
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
            background: linear-gradient(180deg, #fff 0%, rgba(255,255,255,0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 40px;
        }

        /* Form */
        .form-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--card);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: visible;
        }
        
        .form-table tr { border-bottom: 1px solid var(--border); }
        .form-table tr:last-child { border-bottom: none; }
        .form-table td { padding: 16px 20px; vertical-align: middle; }
        .form-table td:first-child { color: var(--text-secondary); width: 180px; font-size: 14px; font-weight: 500; }
        
        .form-table input, .form-table select {
            padding: 12px 14px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s;
        }
        
        .form-table input:focus, .form-table select:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(191, 90, 242, 0.2);
        }
        
        .form-table input[type="number"] { width: 75px; text-align: center; }
        .form-table input.year-input { width: 90px; }
        .form-table input.city-input { width: 100%; max-width: 280px; }
        .form-table select { 
            background: var(--input-bg); 
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2386868b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .separator { color: var(--text-secondary); margin: 0 4px; }
        .coords { color: var(--text-secondary); font-size: 12px; margin-top: 8px; }

        /* Calculate Button */
        .calc-btn {
            display: block;
            width: 100%;
            max-width: 320px;
            margin: 32px auto;
            padding: 18px 32px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #fff;
            border: none;
            border-radius: 980px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            letter-spacing: -0.01em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .calc-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 12px 40px rgba(191, 90, 242, 0.4);
        }
        
        .calc-btn:disabled { opacity: 0.5; cursor: wait; transform: none; }

        /* Suggestions */
        .input-group { position: relative; }
        .suggestions {
            position: absolute;
            background: rgba(29, 29, 31, 0.98);
            backdrop-filter: blur(20px);
            width: 100%;
            max-width: 280px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            border: 1px solid var(--border);
            border-radius: 12px;
            display: none;
            top: calc(100% + 4px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .suggestion-item { padding: 14px 16px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 14px; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: rgba(255,255,255,0.05); }

        /* Results */
        .result-section { display: none; margin-top: 40px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 24px 0;
            background: var(--card);
            padding: 6px;
            border-radius: 12px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        .mode-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .mode-tab:hover { color: var(--text); }
        .mode-tab.active { background: var(--accent); color: #fff; }

        /* Chart */
        #chartDiv {
            background: var(--card);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin: 24px auto;
            max-width: 600px;
            overflow: visible;
            box-sizing: border-box;
        }

        /* View Tabs */
        .view-tabs {
            display: none; /* –£–±—Ä–∞–Ω—ã –ø–æ–¥–≤–∫–ª–∞–¥–∫–∏ */
            justify-content: center;
            margin: 24px auto;
            background: var(--card);
            padding: 4px;
            border-radius: 10px;
            width: fit-content;
        }
        
        .view-tab {
            padding: 10px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .view-tab:hover { color: var(--text); }
        .view-tab.active { background: rgba(255,255,255,0.1); color: var(--text); }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--card);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: visible;
            font-size: 14px;
        }
        
        .data-table th {
            background: rgba(255,255,255,0.03);
            color: var(--text-secondary);
            font-weight: 500;
            text-align: left;
            padding: 14px 16px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .data-table td { padding: 14px 16px; border-top: 1px solid var(--border); }
        .data-table tr:hover td { background: rgba(255,255,255,0.02); }

        /* Aspect Matrix */
        .aspect-matrix-table {
            border-collapse: collapse;
            margin: 20px auto;
            font-size: 11px;
        }
        
        .aspect-matrix-table th, .aspect-matrix-table td {
            width: 32px;
            height: 32px;
            text-align: center;
            border: 1px solid var(--border);
            padding: 4px;
        }
        
        .aspect-matrix-table th { background: rgba(255,255,255,0.03); font-size: 12px; }
        .matrix-icon { font-size: 14px; }

        /* Planet Text Blocks */
        .planet-text-block {
            background: var(--card);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            border-left: 3px solid var(--accent);
        }
        
        .planet-text-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }
        
        .planet-text-body {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Extra Settings */
        .extra-settings {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
        }
        
        .extra-settings h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }
        
        .extra-settings button {
            padding: 10px 20px;
            background: var(--accent);
            border: none;
            color: #fff;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .extra-settings button:hover { opacity: 0.9; }

        /* Aspect Legend */
        .aspect-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin: 20px 0;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Result Header */
        .result-name { color: var(--accent); font-size: 28px; font-weight: 700; }
        .result-info { color: var(--text-secondary); font-size: 14px; margin: 8px 0; }
        #resTransit { color: #ffd700; font-weight: 500; }

        /* Error */
        .error-msg {
            background: rgba(255, 59, 48, 0.15);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: #ff453a;
            padding: 16px 20px;
            border-radius: 12px;
            margin-top: 16px;
            display: none;
            font-size: 14px;
        }

        /* Buttons */
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .action-btn:hover { background: rgba(255,255,255,0.08); }

        /* Radio/Checkbox */
        input[type="radio"] {
            accent-color: var(--accent);
            width: 18px;
            height: 18px;
        }

        /* Section Title */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin: 32px 0 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .container { padding: 24px 16px; }
            h1 { font-size: 24px; }
            .form-table td:first-child { display: block; width: 100%; padding-bottom: 8px; }
            .form-table td { display: block; padding: 12px 16px; }
            .form-table input.city-input { max-width: 100%; }
            .calc-btn { max-width: 100%; }
            #chartDiv { padding: 12px; }
            .data-table { font-size: 12px; }
            .data-table th, .data-table td { padding: 10px 12px; }
            .planet-text-block { padding: 16px; }
        }
</style>
</head>
<body>
    <div class="container">
        <h1>–¢—Ä–∞–Ω–∑–∏—Ç—ã. –û–Ω–ª–∞–π–Ω —Ä–∞—Å—á—ë—Ç</h1>
        <p class="subtitle">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç</p>

        <!-- INPUT FORM -->
        <div id="inputForm">
            <table class="form-table">
                <tr>
                    <td>–ò–º—è:</td>
                    <td><input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è" value=""></td>
                </tr>
                <tr>
                    <td>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</td>
                    <td>
                        <div class="row">
                            <input type="number" id="day" placeholder="–î–î" min="1" max="31">
                            <select id="month">
                                <option value="1">–Ø–Ω–≤–∞—Ä—è</option>
                                <option value="2">–§–µ–≤—Ä–∞–ª—è</option>
                                <option value="3">–ú–∞—Ä—Ç–∞</option>
                                <option value="4">–ê–ø—Ä–µ–ª—è</option>
                                <option value="5">–ú–∞—è</option>
                                <option value="6">–ò—é–Ω—è</option>
                                <option value="7">–ò—é–ª—è</option>
                                <option value="8">–ê–≤–≥—É—Å—Ç–∞</option>
                                <option value="9">–°–µ–Ω—Ç—è–±—Ä—è</option>
                                <option value="10">–û–∫—Ç—è–±—Ä—è</option>
                                <option value="11">–ù–æ—è–±—Ä—è</option>
                                <option value="12">–î–µ–∫–∞–±—Ä—è</option>
                            </select>
                            <span class="separator">,</span>
                            <input type="number" id="year" placeholder="–ì–ì–ì–ì" class="year-input" min="1900" max="2100">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è:</td>
                    <td>
                        <div class="row">
                            <input type="number" id="hour" placeholder="–ß–ß" min="0" max="23">
                            <span class="separator">:</span>
                            <input type="number" id="minute" placeholder="–ú–ú" min="0" max="59">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è:</td>
                    <td>
                        <div class="input-group">
                            <input type="text" id="city" class="city-input" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥..." oninput="suggestCity()" autocomplete="off">
                            <div class="suggestions" id="suggestions"></div>
                        </div>
                        <div class="coords" id="coordsDisplay">–®–∏—Ä–æ—Ç–∞: ‚Äî, –î–æ–ª–≥–æ—Ç–∞: ‚Äî</div>
                        <input type="hidden" id="lat">
                        <input type="hidden" id="lon">
                    </td>
                </tr>
                <tr>
                    <td>–ü–æ–ª:</td>
                    <td>
                        <div class="row">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="gender" value="male" checked> –ú—É–∂—Å–∫–æ–π
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; margin-left: 15px;">
                                <input type="radio" name="gender" value="female"> –ñ–µ–Ω—Å–∫–∏–π
                            </label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>–î–∞—Ç–∞ —Ä–∞—Å—á–µ—Ç–∞ (—Ç—Ä–∞–Ω–∑–∏—Ç):</td>
                    <td>
                        <div class="row">
                            <input type="number" id="t_day" placeholder="–î–î" min="1" max="31">
                            <select id="t_month">
                                <option value="1">–Ø–Ω–≤–∞—Ä—è</option>
                                <option value="2">–§–µ–≤—Ä–∞–ª—è</option>
                                <option value="3">–ú–∞—Ä—Ç–∞</option>
                                <option value="4">–ê–ø—Ä–µ–ª—è</option>
                                <option value="5">–ú–∞—è</option>
                                <option value="6">–ò—é–Ω—è</option>
                                <option value="7">–ò—é–ª—è</option>
                                <option value="8">–ê–≤–≥—É—Å—Ç–∞</option>
                                <option value="9">–°–µ–Ω—Ç—è–±—Ä—è</option>
                                <option value="10">–û–∫—Ç—è–±—Ä—è</option>
                                <option value="11">–ù–æ—è–±—Ä—è</option>
                                <option value="12">–î–µ–∫–∞–±—Ä—è</option>
                            </select>
                            <span class="separator">,</span>
                            <input type="number" id="t_year" placeholder="–ì–ì–ì–ì" class="year-input" min="1900" max="2100">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>–í—Ä–µ–º—è —Ä–∞—Å—á–µ—Ç–∞:</td>
                    <td>
                        <div class="row">
                            <input type="number" id="t_hour" placeholder="–ß–ß" min="0" max="23">
                            <span class="separator">:</span>
                            <input type="number" id="t_minute" placeholder="–ú–ú" min="0" max="59">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ (–¥–ª—è —Ç—Ä–∞–Ω–∑–∏—Ç–∞):</td>
                    <td>
                        <div class="input-group">
                            <input type="text" id="transit_city" class="city-input" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥..." oninput="suggestTransitCity()" autocomplete="off">
                            <div class="suggestions" id="transit_suggestions"></div>
                        </div>
                        <div class="coords" id="transitCoordsDisplay">–®–∏—Ä–æ—Ç–∞: ‚Äî, –î–æ–ª–≥–æ—Ç–∞: ‚Äî</div>
                        <input type="hidden" id="transit_lat">
                        <input type="hidden" id="transit_lon">
                    </td>
                </tr>
            </table>

            <button class="calc-btn" id="calcBtn" onclick="calculate()">–†–ê–°–°–ß–ò–¢–ê–¢–¨ –¢–†–ê–ù–ó–ò–¢–´</button>
            <div id="errorMsg" class="error-msg"></div>
        </div>

        <!-- RESULTS -->
        <div id="result" class="result-section">
            <!-- Mode Tabs: –ù–∞—Ç–∞–ª / –°–æ–ª—è—Ä / –õ—É–Ω–∞—Ä -->
            <div class="mode-tabs">
                <button class="mode-tab active" data-mode="transit" onclick="setMode('transit')">–¢—Ä–∞–Ω–∑–∏—Ç—ã</button>
                <button class="mode-tab" data-mode="natal" onclick="setMode('natal')">–ù–∞—Ç–∞–ª</button>
                <button class="mode-tab" data-mode="solar" onclick="setMode('solar')">–°–æ–ª—è—Ä</button>
                <button class="mode-tab" data-mode="lunar" onclick="setMode('lunar')">–õ—É–Ω–∞—Ä</button>
                <button class="mode-tab" data-mode="synastry" onclick="setMode('synastry')">–°–∏–Ω–∞—Å—Ç—Ä–∏—è</button>
            </div>

            <!-- Extra settings for Solar/Lunar -->
            <div id="solarSettings" class="extra-settings" style="display:none;">
                <h4>‚òÄÔ∏è –°–æ–ª—è—Ä ‚Äî –≥–æ–¥ –∏ –º–µ—Å—Ç–æ</h4>
                <div class="row" style="gap:12px;">
                    <span>–ì–æ–¥:</span>
                    <input type="number" id="solar_year" style="width:100px">
                </div>
                <div style="height:10px"></div>
                <div>
                    <div class="input-group">
                        <input type="text" id="solar_city" class="city-input" placeholder="–ì–æ—Ä–æ–¥ —Å–æ–ª—è—Ä–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å ‚Äî –≥–æ—Ä–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è)" oninput="suggestSolarCity()" autocomplete="off">
                        <div class="suggestions" id="solar_suggestions"></div>
                    </div>
                    <div class="coords" id="solarCoordsDisplay">–®–∏—Ä–æ—Ç–∞: ‚Äî, –î–æ–ª–≥–æ—Ç–∞: ‚Äî</div>
                    <input type="hidden" id="solar_lat">
                    <input type="hidden" id="solar_lon">
                </div>
                <div style="height:12px"></div>
                <button onclick="calculateSolar()" style="padding:12px 24px; background:linear-gradient(135deg, #ffd60a, #ff9500); border:none; color:#000; border-radius:10px; cursor:pointer; font-weight:600; font-size:14px;">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–æ–ª—è—Ä</button>
            </div>
            <div id="lunarSettings" class="extra-settings" style="display:none;">
                <h4>üåô –õ—É–Ω–∞—Ä ‚Äî –º–µ—Å—è—Ü –∏ –º–µ—Å—Ç–æ</h4>
                <div class="row" style="gap:12px;">
                    <span>–ú–µ—Å—è—Ü:</span>
                    <input type="number" id="lunar_month" style="width:60px" placeholder="–ú–ú">
                    <input type="number" id="lunar_year" style="width:100px" placeholder="–ì–ì–ì–ì">
                </div>
                <div style="height:10px"></div>
                <div>
                    <div class="input-group">
                        <input type="text" id="lunar_city" class="city-input" placeholder="–ì–æ—Ä–æ–¥ –ª—É–Ω–∞—Ä–∞ (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å ‚Äî –≥–æ—Ä–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è)" oninput="suggestLunarCity()" autocomplete="off">
                        <div class="suggestions" id="lunar_suggestions"></div>
                    </div>
                    <div class="coords" id="lunarCoordsDisplay">–®–∏—Ä–æ—Ç–∞: ‚Äî, –î–æ–ª–≥–æ—Ç–∞: ‚Äî</div>
                    <input type="hidden" id="lunar_lat">
                    <input type="hidden" id="lunar_lon">
                </div>
                <div style="height:12px"></div>
                <button onclick="calculateLunar()" style="padding:12px 24px; background:linear-gradient(135deg, #a8dadc, #457b9d); border:none; color:#fff; border-radius:10px; cursor:pointer; font-weight:600; font-size:14px;">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ª—É–Ω–∞—Ä</button>
            </div>
            <!-- Synastry Form -->
            <div id="synastryForm" class="extra-settings" style="display:none;">
                <h4 style="margin-bottom:15px;">üíï –°–∏–Ω–∞—Å—Ç—Ä–∏—è ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞</h4>
                <div style="display:grid;gap:12px;">
                    <input type="text" id="partner_name" placeholder="–ò–º—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞" style="padding:12px;background:var(--input-bg);border:1px solid var(--border);color:var(--text);border-radius:10px;">
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <input type="number" id="partner_day" placeholder="–î–µ–Ω—å" min="1" max="31" style="width:70px;padding:12px;background:var(--input-bg);border:1px solid var(--border);color:var(--text);border-radius:10px;">
                        <input type="number" id="partner_month" placeholder="–ú–µ—Å—è—Ü" min="1" max="12" style="width:80px;padding:12px;background:var(--input-bg);border:1px solid var(--border);color:var(--text);border-radius:10px;">
                        <input type="number" id="partner_year" placeholder="–ì–æ–¥" min="1900" max="2100" style="width:90px;padding:12px;background:var(--input-bg);border:1px solid var(--border);color:var(--text);border-radius:10px;">
                    </div>
                    <div style="display:flex;gap:10px;">
                        <input type="number" id="partner_hour" placeholder="–ß–∞—Å" min="0" max="23" style="width:70px;padding:12px;background:var(--input-bg);border:1px solid var(--border);color:var(--text);border-radius:10px;">
                        <input type="number" id="partner_minute" placeholder="–ú–∏–Ω" min="0" max="59" style="width:70px;padding:12px;background:var(--input-bg);border:1px solid var(--border);color:var(--text);border-radius:10px;">
                    </div>
                    <div style="position:relative;">
                        <input type="text" id="partner_city" placeholder="–ì–æ—Ä–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞" oninput="suggestPartnerCity()" autocomplete="off" style="width:100%;padding:12px;background:var(--input-bg);border:1px solid var(--border);color:var(--text);border-radius:10px;">
                        <div id="partner_suggestions" class="suggestions" style="display:none;"></div>
                    </div>
                    <input type="hidden" id="partner_lat">
                    <input type="hidden" id="partner_lon">
                    <button onclick="calculateSynastry()" style="padding:14px 24px;background:linear-gradient(135deg,#e91e63,#9c27b0);border:none;color:white;border-radius:10px;cursor:pointer;font-weight:600;font-size:16px;">üíï –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</button>
                </div>
            </div>


            <h2 style="text-align:center">
                <span id="resName" style="color: var(--accent)"></span> ‚Äî —Ä–∞—Å—á–µ—Ç –¢—Ä–∞–Ω–∑–∏—Ç–æ–≤
            </h2>
            <div style="text-align: center; color: #888; font-size: 14px; margin-bottom: 10px;">
                <div>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: <span id="resBirth"></span></div>
                <div>–ú–µ—Å—Ç–æ: <span id="resCity"></span></div>
                <div id="resTransit" style="color: var(--blue);"></div>
            </div>

            <!-- View Tabs: –ù–∞—Ç–∞–ª—å–Ω—ã–µ / –¢—Ä–∞–Ω–∑–∏—Ç—ã -->
            <div class="view-tabs" id="viewTabs">
                <button class="view-tab active" data-view="natal" onclick="setView('natal')">–ù–∞—Ç–∞–ª—å–Ω—ã–µ</button>
                <button class="view-tab" data-view="transit" onclick="setView('transit')">–¢—Ä–∞–Ω–∑–∏—Ç—ã</button>
            </div>

            <!-- Chart -->
            <div id="chartDiv"></div>

            <!-- Matrix & Tables -->
            <div class="scheme-box">
                <h3 style="text-align:center; margin-top:0">‚ú® <span id="matrixTitle">–ú–∞—Ç—Ä–∏—Ü–∞ –∞—Å–ø–µ–∫—Ç–æ–≤</span></h3>
                <div class="aspect-matrix-wrapper">
                    <table id="aspectMatrixTable" class="aspect-matrix-table"></table>
                </div>
                <div id="transitMeta" class="info-text"></div>
                <div class="aspect-legend">
                    <div class="aspect-legend-item"><span class="legend-symbol asp-conj">‚óè</span>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ 0¬∞</div>
                    <div class="aspect-legend-item"><span class="legend-symbol asp-sextile">‚ú∂</span>–°–µ–∫—Å—Ç–∏–ª—å 60¬∞</div>
                    <div class="aspect-legend-item"><span class="legend-symbol asp-trine">‚ñ≥</span>–¢—Ä–∏–≥–æ–Ω 120¬∞</div>
                    <div class="aspect-legend-item"><span class="legend-symbol asp-square">‚ñ°</span>–ö–≤–∞–¥—Ä–∞—Ç 90¬∞</div>
                    <div class="aspect-legend-item"><span class="legend-symbol asp-opposition">‚òç</span>–û–ø–ø–æ–∑–∏—Ü–∏—è 180¬∞</div>
                    <div class="aspect-legend-item"><span style="color:#ff5555">R</span>–†–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω—ã–π</div>
                </div>
            </div>

            <div id="planetsTableContainer" class="scheme-box">
                <h3 style="text-align:center; margin-top:0">ü™ê –ü–ª–∞–Ω–µ—Ç—ã</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–ü–ª–∞–Ω–µ—Ç–∞</th>
                            <th>–ù–∞—Ç–∞–ª—å–Ω–∞—è –¥–æ–ª–≥–æ—Ç–∞</th>
                            <th>–î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ</th>
                            <th id="transitColHeader">–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–æ–ª–≥–æ—Ç–∞</th>
                        </tr>
                    </thead>
                    <tbody id="planetsTableBody"></tbody>
                </table>
                <div id="planetsCards" class="data-cards"></div>
            </div>

            <!-- Texts -->
            <div class="text-section">
                <h3 style="text-align:center">üìñ –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</h3>
                <div id="textsList"></div>
            </div>

            <button onclick="downloadPDF()" style="display:block; width:100%; max-width:300px; margin:30px auto; padding:15px; background:#444; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
                üìÑ –°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç
            </button>
            
            <button onclick="goBack()" style="display:block; width:100%; max-width:300px; margin:10px auto 50px; padding:12px; background:transparent; color:var(--blue); border:1px solid var(--blue); border-radius:8px; font-size:14px; cursor:pointer;">
                ‚Üê –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            </button>
        </div>
    </div>

    <script>
        let currentMode = 'transit';
        let currentView = 'natal';
        let globalData = null;
        let birthData = {};


                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –ø–æ–ª—è–º–∏
        function setupAutoFocus() {
            const fieldGroups = [
                ['day', 'month', 'year', 'hour', 'minute', 'city'],
                ['t_day', 't_month', 't_year', 't_hour', 't_minute']
            ];
            
            fieldGroups.forEach(group => {
                group.forEach((fieldId, index) => {
                    const field = document.getElementById(fieldId);
                    if (!field) return;
                    
                    if (field.tagName === 'INPUT' && field.type === 'number') {
                        field.addEventListener('input', function() {
                            const maxLen = this.placeholder === '–ì–ì–ì–ì' ? 4 : 2;
                            if (this.value.length >= maxLen && index < group.length - 1) {
                                const nextField = document.getElementById(group[index + 1]);
                                if (nextField) nextField.focus();
                            }
                        });
                    }
                    
                    if (field.tagName === 'SELECT') {
                        field.addEventListener('change', function() {
                            if (index < group.length - 1) {
                                const nextField = document.getElementById(group[index + 1]);
                                if (nextField) nextField.focus();
                            }
                        });
                    }
                });
            });

            // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –¥–ª—è –ø–æ–ª–µ–π —Å–∏–Ω–∞—Å—Ç—Ä–∏–∏
            const synFields = ['partner_day', 'partner_month', 'partner_year', 'partner_hour', 'partner_minute', 'partner_city'];
            synFields.forEach((fieldId, index) => {
                const field = document.getElementById(fieldId);
                if (!field) return;
                if (field.type === 'number') {
                    field.addEventListener('input', function() {
                        const maxLen = fieldId.includes('year') ? 4 : 2;
                        if (this.value.length >= maxLen && index < synFields.length - 1) {
                            const next = document.getElementById(synFields[index + 1]);
                            if (next) next.focus();
                        }
                    });
                }
            });
        }

        // Init
        window.addEventListener('load', () => {
            setDefaultDates();
            setupAutoFocus();
            document.documentElement.dataset.theme = currentMode;
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
        });

        function setDefaultDates() {
            const now = new Date();
            document.getElementById('t_day').value = now.getDate();
            document.getElementById('t_month').value = now.getMonth() + 1;
            document.getElementById('t_year').value = now.getFullYear();
            document.getElementById('t_hour').value = now.getHours();
            document.getElementById('t_minute').value = now.getMinutes();
        }

        // City search - Nominatim API (–º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π)
        let abortCtrl = null;
        let searchTimer = null;
        
        function suggestCity() {
            const val = document.getElementById('city').value.trim();
            const list = document.getElementById('suggestions');
            
            if (val.length < 2) { 
                list.style.display = 'none'; 
                return; 
            }
            
            // –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å
            if (abortCtrl) abortCtrl.abort();
            if (searchTimer) clearTimeout(searchTimer);
            
            // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 100–º—Å –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –≤–≤–æ–¥–∞
            searchTimer = setTimeout(() => searchNominatim(val, list), 100);
        }
        
        async function searchNominatim(val, list) {
            abortCtrl = new AbortController();
            
            try {
                const res = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&accept-language=ru&addressdetails=1&limit=8`,
                    { signal: abortCtrl.signal }
                );
                const data = await res.json();
                
                if (!data.length) { 
                    list.style.display = 'none'; 
                    return; 
                }
                
                console.log("Found", data.length, "results for", val); list.innerHTML = '';
                list.style.display = 'block';
                
                const seen = new Set();
                
                data.forEach(p => {
                    const addr = p.address || {};
                    const cityName = addr.city || addr.town || addr.village || addr.hamlet || addr.locality || p.name || p.display_name.split(',')[0];
                    const region = addr.state || addr.region || addr.county || '';
                    const country = addr.country || '';
                    
                    // –£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                    const key = `${cityName}_${String(p.lat).substring(0,6)}`;
                    if (seen.has(key)) return;
                    seen.add(key);
                    
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    const location = [region, country].filter(Boolean).join(', ');
                    div.innerHTML = `<span style="font-weight:500">${cityName}</span><span style="color:#86868b;font-size:12px;margin-left:8px">${location}</span>`;
                    div.onclick = () => selectCity(cityName, p.lat, p.lon);
                    list.appendChild(div);
                });
            } catch(e) { 
                if (e.name !== 'AbortError') console.error(e); 
            }
        }
        
                
        // –ü–æ–∏—Å–∫ –≥–æ—Ä–æ–¥–∞ –ø–∞—Ä—Ç–Ω—ë—Ä–∞
        let partnerAbortCtrl = null;
        let partnerSearchTimer = null;
        
        function suggestPartnerCity() {
            const val = document.getElementById('partner_city').value.trim();
            const list = document.getElementById('partner_suggestions');
            if (val.length < 2) { if(list) list.style.display = 'none'; return; }
            if (partnerAbortCtrl) partnerAbortCtrl.abort();
            if (partnerSearchTimer) clearTimeout(partnerSearchTimer);
            partnerSearchTimer = setTimeout(() => searchPartnerNominatim(val, list), 100);
        }
        
        async function searchPartnerNominatim(val, list) {
            partnerAbortCtrl = new AbortController();
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&accept-language=ru&addressdetails=1&limit=8`, { signal: partnerAbortCtrl.signal });
                const data = await res.json();
                if (!data.length) { list.style.display = 'none'; return; }
                console.log("Found", data.length, "results for", val); list.innerHTML = ''; list.style.display = 'block';
                const seen = new Set();
                data.forEach(p => {
                    const addr = p.address || {};
                    const cityName = addr.city || addr.town || addr.village || addr.hamlet || addr.locality || p.name || p.display_name.split(',')[0];
                    const region = addr.state || addr.region || addr.county || '';
                    const country = addr.country || '';
                    const key = `${cityName}_${String(p.lat).substring(0,6)}`;
                    if (seen.has(key)) return; seen.add(key);
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    const location = [region, country].filter(Boolean).join(', ');
                    div.innerHTML = `<span style="font-weight:500">${cityName}</span><span style="color:#86868b;font-size:12px;margin-left:8px">${location}</span>`;
                    div.onclick = () => selectPartnerCity(cityName, p.lat, p.lon);
                    list.appendChild(div);
                });
            } catch(e) { if (e.name !== 'AbortError') console.error(e); }
        }
        
        function selectPartnerCity(name, lat, lon) {
            document.getElementById('partner_city').value = name;
            document.getElementById('partner_lat').value = lat;
            document.getElementById('partner_lon').value = lon;
            const sugg = document.getElementById('partner_suggestions');
            if (sugg) sugg.style.display = 'none';
        }

function selectCity(name, lat, lon) {
            document.getElementById('city').value = name;
            document.getElementById('lat').value = lat;
            document.getElementById('lon').value = lon;
            document.getElementById('coordsDisplay').textContent = `–®–∏—Ä–æ—Ç–∞: ${parseFloat(lat).toFixed(4)}, –î–æ–ª–≥–æ—Ç–∞: ${parseFloat(lon).toFixed(4)}`;
            document.getElementById('suggestions').style.display = 'none';
        }
        
        // Transit city search
        let transitAbortCtrl = null;
        let transitSearchTimer = null;

        function suggestTransitCity() {
            const val = document.getElementById('transit_city').value.trim();
            const list = document.getElementById('transit_suggestions');
            if (val.length < 2) { if(list) list.style.display = 'none'; return; }
            if (transitAbortCtrl) transitAbortCtrl.abort();
            if (transitSearchTimer) clearTimeout(transitSearchTimer);
            transitSearchTimer = setTimeout(() => searchTransitNominatim(val, list), 100);
        }

        async function searchTransitNominatim(val, list) {
            transitAbortCtrl = new AbortController();
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&accept-language=ru&addressdetails=1&limit=8`, { signal: transitAbortCtrl.signal });
                const data = await res.json();
                if (!data.length) { list.style.display = 'none'; return; }
                console.log("Found", data.length, "results for", val); list.innerHTML = '';
                list.style.display = 'block';
                const seen = new Set();
                data.forEach(p => {
                    const addr = p.address || {};
                    const cityName = addr.city || addr.town || addr.village || addr.hamlet || addr.locality || p.name || p.display_name.split(',')[0];
                    const region = addr.state || addr.region || addr.county || '';
                    const country = addr.country || '';
                    const key = `${cityName}_${String(p.lat).substring(0,6)}`;
                    if (seen.has(key)) return;
                    seen.add(key);
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    const location = [region, country].filter(Boolean).join(', ');
                    div.innerHTML = `<span style="font-weight:500">${cityName}</span><span style="color:#86868b;font-size:12px;margin-left:8px">${location}</span>`;
                    div.onclick = () => selectTransitCity(cityName, p.lat, p.lon);
                    list.appendChild(div);
                });
            } catch(e) { if (e.name !== 'AbortError') console.error(e); }
        }

        function selectTransitCity(name, lat, lon) {
            document.getElementById('transit_city').value = name;
            document.getElementById('transit_lat').value = lat;
            document.getElementById('transit_lon').value = lon;
            const el = document.getElementById('transitCoordsDisplay');
            if (el) el.textContent = `–®–∏—Ä–æ—Ç–∞: ${parseFloat(lat).toFixed(4)}, –î–æ–ª–≥–æ—Ç–∞: ${parseFloat(lon).toFixed(4)}`;
            const list = document.getElementById('transit_suggestions');
            if (list) list.style.display = 'none';
        }

        // Solar city search
        let solarAbortCtrl = null;
        let solarSearchTimer = null;

        function suggestSolarCity() {
            const val = document.getElementById('solar_city').value.trim();
            const list = document.getElementById('solar_suggestions');
            if (val.length < 2) { if(list) list.style.display = 'none'; return; }
            if (solarAbortCtrl) solarAbortCtrl.abort();
            if (solarSearchTimer) clearTimeout(solarSearchTimer);
            solarSearchTimer = setTimeout(() => searchSolarNominatim(val, list), 100);
        }

        async function searchSolarNominatim(val, list) {
            solarAbortCtrl = new AbortController();
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&accept-language=ru&addressdetails=1&limit=8`, { signal: solarAbortCtrl.signal });
                const data = await res.json();
                if (!data.length) { list.style.display = 'none'; return; }
                console.log("Found", data.length, "results for", val); list.innerHTML = '';
                list.style.display = 'block';
                const seen = new Set();
                data.forEach(p => {
                    const addr = p.address || {};
                    const cityName = addr.city || addr.town || addr.village || addr.hamlet || addr.locality || p.name || p.display_name.split(',')[0];
                    const region = addr.state || addr.region || addr.county || '';
                    const country = addr.country || '';
                    const key = `${cityName}_${String(p.lat).substring(0,6)}`;
                    if (seen.has(key)) return;
                    seen.add(key);
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    const location = [region, country].filter(Boolean).join(', ');
                    div.innerHTML = `<span style="font-weight:500">${cityName}</span><span style="color:#86868b;font-size:12px;margin-left:8px">${location}</span>`;
                    div.onclick = () => selectSolarCity(cityName, p.lat, p.lon);
                    list.appendChild(div);
                });
            } catch(e) { if (e.name !== 'AbortError') console.error(e); }
        }

        function selectSolarCity(name, lat, lon) {
            document.getElementById('solar_city').value = name;
            document.getElementById('solar_lat').value = lat;
            document.getElementById('solar_lon').value = lon;
            const el = document.getElementById('solarCoordsDisplay');
            if (el) el.textContent = `–®–∏—Ä–æ—Ç–∞: ${parseFloat(lat).toFixed(4)}, –î–æ–ª–≥–æ—Ç–∞: ${parseFloat(lon).toFixed(4)}`;
            const list = document.getElementById('solar_suggestions');
            if (list) list.style.display = 'none';
        }

        // Lunar city search
        let lunarAbortCtrl = null;
        let lunarSearchTimer = null;

        function suggestLunarCity() {
            const val = document.getElementById('lunar_city').value.trim();
            const list = document.getElementById('lunar_suggestions');
            if (val.length < 2) { if(list) list.style.display = 'none'; return; }
            if (lunarAbortCtrl) lunarAbortCtrl.abort();
            if (lunarSearchTimer) clearTimeout(lunarSearchTimer);
            lunarSearchTimer = setTimeout(() => searchLunarNominatim(val, list), 100);
        }

        async function searchLunarNominatim(val, list) {
            lunarAbortCtrl = new AbortController();
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&accept-language=ru&addressdetails=1&limit=8`, { signal: lunarAbortCtrl.signal });
                const data = await res.json();
                if (!data.length) { list.style.display = 'none'; return; }
                console.log("Found", data.length, "results for", val); list.innerHTML = '';
                list.style.display = 'block';
                const seen = new Set();
                data.forEach(p => {
                    const addr = p.address || {};
                    const cityName = addr.city || addr.town || addr.village || addr.hamlet || addr.locality || p.name || p.display_name.split(',')[0];
                    const region = addr.state || addr.region || addr.county || '';
                    const country = addr.country || '';
                    const key = `${cityName}_${String(p.lat).substring(0,6)}`;
                    if (seen.has(key)) return;
                    seen.add(key);
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    const location = [region, country].filter(Boolean).join(', ');
                    div.innerHTML = `<span style="font-weight:500">${cityName}</span><span style="color:#86868b;font-size:12px;margin-left:8px">${location}</span>`;
                    div.onclick = () => selectLunarCity(cityName, p.lat, p.lon);
                    list.appendChild(div);
                });
            } catch(e) { if (e.name !== 'AbortError') console.error(e); }
        }

        function selectLunarCity(name, lat, lon) {
            document.getElementById('lunar_city').value = name;
            document.getElementById('lunar_lat').value = lat;
            document.getElementById('lunar_lon').value = lon;
            const el = document.getElementById('lunarCoordsDisplay');
            if (el) el.textContent = `–®–∏—Ä–æ—Ç–∞: ${parseFloat(lat).toFixed(4)}, –î–æ–ª–≥–æ—Ç–∞: ${parseFloat(lon).toFixed(4)}`;
            const list = document.getElementById('lunar_suggestions');
            if (list) list.style.display = 'none';
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-group')) {
                document.querySelectorAll('.suggestions').forEach(s => s.style.display = 'none');
            }
        });

        // Calculate
        async function calculate() {
            const btn = document.getElementById('calcBtn');
            const errorDiv = document.getElementById('errorMsg');
            
            // Validate
            const fields = ['day', 'month', 'year', 'hour', 'minute', 'city', 't_day', 't_month', 't_year', 't_hour', 't_minute'];
            for (let id of fields) {
                if (!document.getElementById(id).value) {
                    errorDiv.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                    errorDiv.style.display = 'block';
                    return;
                }
            }
            
            btn.innerHTML = "‚è≥ –í—ã—á–∏—Å–ª—è—é...";
            btn.disabled = true;
            errorDiv.style.display = 'none';

            const genderRadio = document.querySelector('input[name="gender"]:checked');
            birthData = {
                name: document.getElementById('name').value || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                gender: genderRadio ? genderRadio.value : "male",
                year: parseInt(document.getElementById('year').value),
                month: parseInt(document.getElementById('month').value),
                day: parseInt(document.getElementById('day').value),
                hour: parseInt(document.getElementById('hour').value),
                minute: parseInt(document.getElementById('minute').value),
                city: document.getElementById('city').value,
                lat: parseFloat(document.getElementById('lat').value) || null,
                lon: parseFloat(document.getElementById('lon').value) || null,
                mode: 'natal',
                transit_year: parseInt(document.getElementById('t_year').value),
                transit_month: parseInt(document.getElementById('t_month').value),
                transit_day: parseInt(document.getElementById('t_day').value),
                transit_hour: parseInt(document.getElementById('t_hour').value),
                transit_minute: parseInt(document.getElementById('t_minute').value),
                transit_city: document.getElementById('transit_city').value || document.getElementById('city').value,
                transit_lat: parseFloat(document.getElementById('transit_lat').value) || (parseFloat(document.getElementById('lat').value) || null),
                transit_lon: parseFloat(document.getElementById('transit_lon').value) || (parseFloat(document.getElementById('lon').value) || null)
            };

            try {
                const res = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(birthData)
                });
                const result = await res.json();
                
                if (result.error) throw new Error(result.error);

                globalData = result;
                
                // Set solar/lunar defaults
                document.getElementById('solar_year').value = new Date().getFullYear();
                document.getElementById('lunar_month').value = new Date().getMonth() + 1;
                document.getElementById('lunar_year').value = new Date().getFullYear();
                
                renderResult(result);
                document.getElementById('inputForm').style.display = 'none';
                document.getElementById('result').style.display = 'block';
                window.scrollTo({top: 0, behavior: 'smooth'});
            } catch (e) {
                errorDiv.textContent = "–û—à–∏–±–∫–∞: " + e.message;
                errorDiv.style.display = 'block';
            } finally {
                btn.innerHTML = "–†–ê–°–°–ß–ò–¢–ê–¢–¨ –¢–†–ê–ù–ó–ò–¢–´";
                btn.disabled = false;
            }
        }

        function goBack() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('inputForm').style.display = 'block';
        }

        // Mode switching
        function setMode(mode) {
            currentMode = mode;
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.mode-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.mode === mode);
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const solarEl = document.getElementById('solarSettings');
            const lunarEl = document.getElementById('lunarSettings');
            const synEl = document.getElementById('synastryForm');
            
            if (solarEl) solarEl.style.display = mode === 'solar' ? 'block' : 'none';
            if (lunarEl) lunarEl.style.display = mode === 'lunar' ? 'block' : 'none';
            if (synEl) synEl.style.display = mode === 'synastry' ? 'block' : 'none';
            
            // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –±–ª–æ–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            const chartDiv = document.getElementById('chartDiv');
            const viewTabs = document.getElementById('viewTabs');
            const schemeBox = document.querySelector('.scheme-box');
            const planetsTable = document.getElementById('planetsTableContainer');
            const textsList = document.getElementById('textsList');
            const synastryResult = document.getElementById('synastryResult');
            
            const isSynastry = mode === 'synastry';
            
            // –î–ª—è —Å–∏–Ω–∞—Å—Ç—Ä–∏–∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É, —Ç–∞–±–ª–∏—Ü—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º—É/—Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (chartDiv) chartDiv.style.display = isSynastry ? 'none' : 'block';
            // –ü–æ–¥–≤–∫–ª–∞–¥–∫–∏ —É–±—Ä–∞–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å—ë —Å—Ä–∞–∑—É
            if (schemeBox) schemeBox.style.display = isSynastry ? 'none' : 'block';
            if (planetsTable) planetsTable.style.display = isSynastry ? 'none' : 'block';
            
            // –î–ª—è —Å–∏–Ω–∞—Å—Ç—Ä–∏–∏ textsList –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ - –Ω–µ —Å–∫—Ä—ã–≤–∞–µ–º
            // –Ω–æ –æ—á–∏—â–∞–µ–º –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –¥—Ä—É–≥–æ–π —Ä–µ–∂–∏–º
            if (!isSynastry && textsList && textsList.querySelector('[data-synastry]')) {
                textsList.innerHTML = '';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const titleMap = {
                'transit': '—Ä–∞—Å—á–µ—Ç –¢—Ä–∞–Ω–∑–∏—Ç–æ–≤',
                'natal': '–ù–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞',
                'solar': '–°–æ–ª—è—Ä',
                'lunar': '–õ—É–Ω–∞—Ä',
                'synastry': '–°–∏–Ω–∞—Å—Ç—Ä–∏—è'
            };
            const h2 = document.querySelector('#result h2');
            if (h2) {
                const name = document.getElementById('resName')?.textContent || '';
                h2.innerHTML = '<span id="resName" style="color: var(--accent)">' + name + '</span> ‚Äî ' + (titleMap[mode] || '—Ä–∞—Å—á–µ—Ç');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤ –∫—Ä–æ–º–µ —Å–∏–Ω–∞—Å—Ç—Ä–∏–∏
            if (!isSynastry && globalData) {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –≤ –¥–∞–Ω–Ω—ã—Ö
                globalData.mode = mode;
                renderPlanetsTable(globalData);
                renderTexts(globalData);
                updateDisplay();
            }

            document.documentElement.dataset.theme = mode;
        }

        async function calculateSolar() {
            const year = parseInt(document.getElementById('solar_year').value);
            if (!year) return alert('–£–∫–∞–∂–∏—Ç–µ –≥–æ–¥');
            
            const data = {...birthData, mode: 'solar', solar_year: year,
                solar_city: document.getElementById('solar_city').value || birthData.city,
                solar_lat: parseFloat(document.getElementById('solar_lat').value) || birthData.lat || null,
                solar_lon: parseFloat(document.getElementById('solar_lon').value) || birthData.lon || null
            };
            const res = await fetch('/api/calculate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.error) return alert(result.error);
            globalData = result;
            renderPlanetsTable(result);
            renderTexts(result);
            updateDisplay();
        }

        async function calculateLunar() {
            const month = parseInt(document.getElementById('lunar_month').value);
            const year = parseInt(document.getElementById('lunar_year').value);
            if (!month || !year) return alert('–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—è—Ü –∏ –≥–æ–¥');
            
            const data = {...birthData, mode: 'lunar', lunar_month: month, lunar_year: year,
                lunar_city: document.getElementById('lunar_city').value || birthData.city,
                lunar_lat: parseFloat(document.getElementById('lunar_lat').value) || birthData.lat || null,
                lunar_lon: parseFloat(document.getElementById('lunar_lon').value) || birthData.lon || null
            };
            const res = await fetch('/api/calculate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.error) return alert(result.error);
            globalData = result;
            updateDisplay();
        }

        
        async function calculateSynastry() {
            if (!birthData.name) return alert("–°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Å–≤–æ—é –∫–∞—Ä—Ç—É");
            
            const pName = document.getElementById("partner_name").value;
            const pDay = parseInt(document.getElementById("partner_day").value);
            const pMonth = parseInt(document.getElementById("partner_month").value);
            const pYear = parseInt(document.getElementById("partner_year").value);
            const pHour = parseInt(document.getElementById("partner_hour").value) || 12;
            const pMinute = parseInt(document.getElementById("partner_minute").value) || 0;
            const pCity = document.getElementById("partner_city").value;
            
            if (!pName || !pDay || !pMonth || !pYear || !pCity) {
                return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞");
            }
            
            const pLat = parseFloat(document.getElementById('partner_lat').value) || 55.75;
            const pLon = parseFloat(document.getElementById('partner_lon').value) || 37.62;
            
            const data = {
                name1: birthData.name,
                year1: birthData.year,
                month1: birthData.month,
                day1: birthData.day,
                hour1: birthData.hour,
                minute1: birthData.minute,
                city1: birthData.city,
                lat1: birthData.lat,
                lon1: birthData.lon,
                gender1: birthData.gender,
                name2: pName,
                year2: pYear,
                month2: pMonth,
                day2: pDay,
                hour2: pHour,
                minute2: pMinute,
                city2: pCity,
                lat2: pLat,
                lon2: pLon,
            };
            
            try {
                const res = await fetch("/api/synastry", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                
                if (result.error) return alert(result.error);
                
                showSynastryResult(result);
            } catch(e) {
                alert("–û—à–∏–±–∫–∞: " + e.message);
            }
        }
        
        function showSynastryResult(result) {
            const scoreColor = result.score >= 70 ? "#4caf50" : result.score >= 50 ? "#ffc107" : "#f44336";
            
            let html = '<div style="background:var(--card);border:1px solid var(--border);border-radius:20px;padding:30px;margin:20px 0;text-align:center;">';
            html += '<h3 style="margin-bottom:20px;">üíï –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</h3>';
            html += '<div style="font-size:64px;font-weight:700;color:' + scoreColor + ';margin:20px 0;">' + result.score + '%</div>';
            html += '<div style="font-size:20px;color:var(--text);margin-bottom:15px;">' + result.level + '</div>';
            html += '<p style="color:var(--text-secondary);max-width:500px;margin:0 auto 20px;">' + result.description + '</p>';
            html += '<div style="display:flex;justify-content:center;gap:30px;margin-top:20px;">';
            html += '<div><span style="color:#4caf50;font-weight:700;">' + (result.positive_count || 0) + '</span> –≥–∞—Ä–º–æ–Ω–∏—á–Ω—ã—Ö</div>';
            html += '<div><span style="color:#f44336;font-weight:700;">' + (result.challenging_count || 0) + '</span> –Ω–∞–ø—Ä—è–∂—ë–Ω–Ω—ã—Ö</div>';
            html += '</div></div>';
            
            if (result.aspects && result.aspects.length > 0) {
                html += '<h4 style="margin:20px 0 10px;">–ö–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã</h4>';
                result.aspects.forEach(function(a) {
                    const color = a.is_positive ? "#4caf50" : a.is_challenging ? "#f44336" : "#888";
                    html += '<div style="background:var(--card);border-left:3px solid ' + color + ';padding:12px 16px;margin:8px 0;border-radius:8px;">';
                    html += '<b>' + a.p1 + '</b> ' + a.aspect + ' <b>' + a.p2 + '</b>';
                    html += '</div>';
                });
            }
            
            document.getElementById("textsList").innerHTML = html;
            document.getElementById("result").style.display = "block";
            const formEl = document.getElementById("inputSection"); if(formEl) formEl.style.display = "none";
        }

function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.view-tab[data-view="${view}"]`).classList.add('active');
            updateDisplay();
        }

        function updateDisplay() {
            const data = globalData;
            if (!data) return;
            
            const matrixTitle = document.getElementById('matrixTitle');
            const transitMeta = document.getElementById('transitMeta');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–Ω–µ—à–Ω–∏—Ö –ø–ª–∞–Ω–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            let outerPlanets = [];
            let outerAspects = data.aspects;
            let metaText = '';
            
            if (data.mode === 'solar' && data.solar) {
                outerPlanets = data.solar.planets || [];
                outerAspects = data.solar.aspects || data.aspects;
                metaText = `–°–æ–ª—è—Ä: ${data.solar.datetime}`;
            } else if (data.mode === 'lunar' && data.lunar) {
                outerPlanets = data.lunar.planets || [];
                outerAspects = data.lunar.aspects || data.aspects;
                metaText = `–õ—É–Ω–∞—Ä: ${data.lunar.datetime}`;
            } else if (data.transit_planets) {
                outerPlanets = data.transit_planets;
                outerAspects = data.transit_aspects || data.aspects;
                metaText = data.transit_meta ? `–¢—Ä–∞–Ω–∑–∏—Ç—ã: ${data.transit_meta.dt}` : '';
            }
            
            if (currentView === 'natal') {
                matrixTitle.textContent = '–ù–∞—Ç–∞–ª—å–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã';
                transitMeta.textContent = '';
                renderAspectMatrix(data.planets, data.planets, data.aspects, false);
                drawChart(data.planets, data.houses, data.aspects, null);
            } else {
                matrixTitle.textContent = data.mode === 'solar' ? '–°–æ–ª—è—Ä ‚Üî –ù–∞—Ç–∞–ª' :
                                          data.mode === 'lunar' ? '–õ—É–Ω–∞—Ä ‚Üî –ù–∞—Ç–∞–ª' : '–¢—Ä–∞–Ω–∑–∏—Ç ‚Üî –ù–∞—Ç–∞–ª';
                transitMeta.textContent = metaText;
                if (outerPlanets.length > 0) {
                    renderAspectMatrix(data.planets, outerPlanets, outerAspects, true);
                    drawChart(data.planets, data.houses, data.aspects, outerPlanets);
                } else {
                    renderAspectMatrix(data.planets, data.planets, data.aspects, false);
                    drawChart(data.planets, data.houses, data.aspects, null);
                }
            }
        }

        function renderResult(data) {
            document.getElementById('resName').textContent = data.name;
            document.getElementById('resBirth').textContent = data.meta.dt;
            document.getElementById('resCity').textContent = data.meta.city;
            
            if (data.transit_meta) {
                document.getElementById('resTransit').textContent = `–¢—Ä–∞–Ω–∑–∏—Ç—ã –Ω–∞: ${data.transit_meta.dt} ‚Ä¢ –º–µ—Å—Ç–æ: ${data.transit_meta.city}`;
            }
            
            renderPlanetsTable(data);
            renderTexts(data);
            
            currentView = 'transit';  // Start with transit view
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.view-tab[data-view="transit"]').classList.add('active');
            updateDisplay();
        }

        function renderPlanetsTable(data) {
            const tBody = document.getElementById('planetsTableBody');
            tBody.innerHTML = '';
            const cards = document.getElementById('planetsCards');
            if (cards) cards.innerHTML = '';
            
            const mode = currentMode || data.mode || 'transit';
            const transitHeader = document.getElementById('transitColHeader');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–µ –ø–ª–∞–Ω–µ—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
            let transit = [];
            const transitCells = document.querySelectorAll('.transit-cell');
            if (mode === 'natal') {
                transit = [];
                if (transitHeader) transitHeader.style.display = 'none';
                transitCells.forEach(c => c.style.display = 'none');
            } else if (mode === 'solar' && data.solar) {
                if (transitHeader) transitHeader.style.display = '';
                transitCells.forEach(c => c.style.display = '');
                transit = data.solar.planets || [];
                if (transitHeader) transitHeader.textContent = '–°–æ–ª—è—Ä';
            } else if (mode === 'lunar' && data.lunar) {
                transit = data.lunar.planets || [];
                if (transitHeader) { transitHeader.textContent = '–õ—É–Ω–∞—Ä'; transitHeader.style.display = ''; }
                transitCells.forEach(c => c.style.display = '');
            } else {
                transit = data.transit_planets || [];
                if (transitHeader) { transitHeader.textContent = '–¢—Ä–∞–Ω–∑–∏—Ç'; transitHeader.style.display = ''; }
                transitCells.forEach(c => c.style.display = '');
            }
            
            const transitMap = {};
            transit.forEach(p => { if (p.key) transitMap[p.key] = p; });

            const formatPos = (p) => {
                if (!p) return '‚Äî';
                const degree = p.degree || p.pos || 0;
                const deg = Math.floor(degree);
                const min = Math.round((degree % 1) * 60);
                return `${p.sign} ${deg}¬∞${min.toString().padStart(2,'0')}'`;
            };

            data.planets.forEach(p => {
                const retro = p.is_retro ? '<span style="color:#ff5555">R</span>' : '';
                const op = transitMap[p.key];
                const oRetro = op?.is_retro ? '<span style="color:#ff5555">R</span>' : '';
                tBody.innerHTML += `<tr>
                    <td>${p.icon} ${p.name} ${retro}</td>
                    <td>${formatPos(p)}</td>
                    <td>${p.dignity ? '<span style="color:' + (p.dignity=="–û–±–∏—Ç–µ–ª—å"?'#4caf50':p.dignity=="–≠–∫–∑–∞–ª—å—Ç–∞—Ü–∏—è"?'#8bc34a':p.dignity=="–ò–∑–≥–Ω–∞–Ω–∏–µ"?'#f44336':'#ff9800') + '; font-weight:bold;">' + p.dignity + '</span>' : '‚Äî'}</td>
                    <td class="transit-cell">${op ? formatPos(op) + oRetro : '‚Äî'}</td>
                </tr>`;

                if (cards) {
                    const dign = p.dignity || '‚Äî';
                    const tLabel = (mode === 'solar' ? '–°–æ–ª—è—Ä' : mode === 'lunar' ? '–õ—É–Ω–∞—Ä' : '–¢—Ä–∞–Ω–∑–∏—Ç');
                    const tVal = (op ? (formatPos(op) + oRetro) : '‚Äî');
                    cards.innerHTML += `<div class="data-card">
                        <div class="row1">
                            <div class="pname">${p.icon} ${p.name} ${retro}</div>
                            <div class="pill">${tLabel}</div>
                        </div>
                        <div class="grid">
                            <div><div class="k">–ù–∞—Ç–∞–ª</div><div class="v">${formatPos(p)}</div></div>
                            <div><div class="k">${tLabel}</div><div class="v">${tVal}</div></div>
                            <div style="grid-column:1/-1"><div class="k">–î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ</div><div class="v">${dign}</div></div>
                        </div>
                    </div>`;
                }
            });
        }

        function renderTexts(data) {
            const container = document.getElementById('textsList');
            container.innerHTML = '';
            
            const mode = currentMode || data.mode || 'transit';
            const colors = {Square:'#ff5555', Opposition:'#ff5555', Trine:'#8bc34a', Sextile:'#4dd0e1', Conjunction:'#4fc3f7', Quincunx:'#ff9800'};
            const symbols = {Conjunction:'‚òå', Sextile:'‚ú∂', Square:'‚ñ°', Trine:'‚ñ≥', Opposition:'‚òç', Quincunx:'‚§ª'};
            
            if (mode === 'natal') {
                data.planets.forEach(p => {
                    if (p.text && p.key !== 'ASC' && p.key !== 'MC') {
                        container.innerHTML += `<div class="planet-text-block">
                            <div class="planet-text-header">${p.icon} ${p.name} –≤ ${p.sign_locative || p.sign}, ${p.house} –¥–æ–º</div>
                            <div class="planet-text-body">${p.text}</div>
                        </div>`;
                    }
                });
                data.aspects.forEach(a => {
                    container.innerHTML += `<div class="planet-text-block" style="border-left-color:${colors[a.type]||'#ccc'}">
                        <div class="planet-text-header"><span style="color:${colors[a.type]||'#ccc'}">${symbols[a.type]||'‚óè'}</span> ${a.p1} ‚Äî ${a.p2} (${a.name || a.type})</div>
                        <div class="planet-text-body">${a.text || ''}</div>
                    </div>`;
                });
            } 
            else if (mode === 'transit') {
                const transitAspects = data.transit_aspects || [];
                if (transitAspects.length > 0) {
                    container.innerHTML += '<h3 style="margin:20px 0 10px;color:var(--accent)">–¢—Ä–∞–Ω–∑–∏—Ç–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã</h3>';
                    transitAspects.forEach(a => {
                        container.innerHTML += `<div class="planet-text-block" style="border-left-color:${colors[a.type]||'#ccc'}">
                            <div class="planet-text-header"><span style="color:${colors[a.type]||'#ccc'}">${symbols[a.type]||'‚óè'}</span> —Ç—Ä.${a.p1} ‚Üí ${a.p2} (${a.name || a.type})</div>
                            <div class="planet-text-body">${a.text || ''}</div>
                        </div>`;
                    });
                } else {
                    container.innerHTML += '<p style="color:#888">–¢—Ä–∞–Ω–∑–∏—Ç–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                }
            }
            else if (mode === 'solar' && data.solar) {
                const solarAspects = data.solar.aspects || [];
                container.innerHTML += '<h3 style="margin:20px 0 10px;color:var(--accent)">–°–æ–ª—è—Ä: –∞—Å–ø–µ–∫—Ç—ã –∫ –Ω–∞—Ç–∞–ª—å–Ω—ã–º –ø–ª–∞–Ω–µ—Ç–∞–º</h3>';
                if (solarAspects.length > 0) {
                    solarAspects.forEach(a => {
                        container.innerHTML += `<div class="planet-text-block" style="border-left-color:${colors[a.type]||'#ccc'}">
                            <div class="planet-text-header"><span style="color:${colors[a.type]||'#ccc'}">${symbols[a.type]||'‚óè'}</span> —Å–æ–ª.${a.p1} ‚Üí ${a.p2} (${a.name || a.type})</div>
                            <div class="planet-text-body">${a.text || ''}</div>
                        </div>`;
                    });
                } else {
                    container.innerHTML += '<p style="color:#888">–ù–∞–∂–º–∏—Ç–µ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–æ–ª—è—Ä</p>';
                }
            }
            else if (mode === 'lunar' && data.lunar) {
                const lunarAspects = data.lunar.aspects || [];
                container.innerHTML += '<h3 style="margin:20px 0 10px;color:var(--accent)">–õ—É–Ω–∞—Ä: –∞—Å–ø–µ–∫—Ç—ã –∫ –Ω–∞—Ç–∞–ª—å–Ω—ã–º –ø–ª–∞–Ω–µ—Ç–∞–º</h3>';
                if (lunarAspects.length > 0) {
                    lunarAspects.forEach(a => {
                        container.innerHTML += `<div class="planet-text-block" style="border-left-color:${colors[a.type]||'#ccc'}">
                            <div class="planet-text-header"><span style="color:${colors[a.type]||'#ccc'}">${symbols[a.type]||'‚óè'}</span> –ª—É–Ω.${a.p1} ‚Üí ${a.p2} (${a.name || a.type})</div>
                            <div class="planet-text-body">${a.text || ''}</div>
                        </div>`;
                    });
                } else {
                    container.innerHTML += '<p style="color:#888">–ù–∞–∂–º–∏—Ç–µ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ª—É–Ω–∞—Ä</p>';
                }
            }
            else {
                container.innerHTML += '<p style="color:#888">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º</p>';
            }
        }

        function drawChart(planets, cusps, aspects, transit) {
            const container = document.getElementById('chartDiv');
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–∂–µ –±—ã–ª –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω
            requestAnimationFrame(() => {
                const width = container.clientWidth || container.offsetWidth || 500;
                const size = Math.min(width - 40, 540);
                container.style.height = (size + 40) + 'px';
                const chart = new NatalChart('chartDiv', size);
                chart.draw({planets, houses: cusps, aspects, outerPlanets: transit});
            });
        }

        function renderAspectMatrix(natal, transit, aspects, isTransit) {
            const table = document.getElementById('aspectMatrixTable');
            table.innerHTML = '';
            
            const order = [
                {key:'Sun',icon:'‚òâ'},{key:'Moon',icon:'‚òæ'},{key:'Mercury',icon:'‚òø'},{key:'Venus',icon:'‚ôÄ'},
                {key:'Mars',icon:'‚ôÇ'},{key:'Jupiter',icon:'‚ôÉ'},{key:'Saturn',icon:'‚ôÑ'},{key:'Uranus',icon:'‚ôÖ'},
                {key:'Neptune',icon:'‚ôÜ'},{key:'Pluto',icon:'‚ôá'},{key:'Lilith',icon:'‚ö∏'},
                {key:'North_node',icon:'‚òä'},{key:'ASC',icon:'AC'},{key:'MC',icon:'MC'}
            ];
            
            const natalMap = {}, transitMap = {}, aspectMap = {};
            natal.forEach(p => { if(p.key) natalMap[p.key]=p; });
            transit.forEach(p => { if(p.key) transitMap[p.key]=p; });
            aspects.forEach(a => {
                if(a.p1_key && a.p2_key) {
                    aspectMap[`${a.p1_key}_${a.p2_key}`] = a;
                    aspectMap[`${a.p2_key}_${a.p1_key}`] = a;
                }
            });
            
            const sym = {
                Conjunction:{c:'‚óè',cls:'asp-conj'}, Sextile:{c:'‚ú∂',cls:'asp-sextile'},
                Square:{c:'‚ñ°',cls:'asp-square'}, Trine:{c:'‚ñ≥',cls:'asp-trine'},
                Opposition:{c:'‚òç',cls:'asp-opposition'}, Quincunx:{c:'‚§ª',cls:'asp-quincunx'}
            };

            const header = document.createElement('tr');
            header.innerHTML = '<th>‚Üì/‚Üí</th>' + order.map(p => `<th><span class="matrix-icon">${p.icon}</span></th>`).join('');
            table.appendChild(header);

            order.forEach((rowP, ri) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<th><span class="matrix-icon">${rowP.icon}</span></th>`;
                order.forEach((colP, ci) => {
                    const td = document.createElement('td');
                    if (!isTransit && ci >= ri) {
                        td.classList.add('matrix-empty');
                    } else {
                        const key = `${rowP.key}_${colP.key}`;
                        const asp = aspectMap[key];
                        if (asp) {
                            const s = sym[asp.type] || sym.Conjunction;
                            td.innerHTML = `<span class="matrix-symbol ${s.cls}">${s.c}</span>`;
                            td.title = `${asp.p1} ${asp.name} ${asp.p2} (${asp.orb}¬∞)`;
                        } else {
                            td.classList.add('matrix-empty');
                        }
                    }
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });
        }

        function downloadPDF() {
            const name = birthData.name || 'report';
            const link = document.createElement('a');
            link.href = `/api/pdf?name=${encodeURIComponent(name)}`;
            link.download = `Transit_${name}.pdf`;
            link.click();
        }
    </script>
</body>
</html>
