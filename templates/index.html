<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—Å—Ç—Ä–æ-–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Custom Chart JS -->
    <script src="/static/chart.js?v=6"></script>
    <style>
        :root { --bg:#1a1a2e; --card:#16213e; --text:#e0e0e0; --accent:#e94560; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; padding: 20px; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; color: #ffd700; margin-bottom: 30px; }
        
        /* Form Styles */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
        
        .input-group { margin-bottom: 15px; position: relative; }
        label { font-size: 12px; color: #888; display: block; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; background: var(--card); border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        input:focus { border-color: var(--accent); outline: none; }
        
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        
        button { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: opacity 0.2s; }
        button:active { opacity: 0.8; }
        button:disabled { opacity: 0.5; cursor: wait; }
        
        /* Results */
        .result-section { display: none; margin-top: 30px; animation: fadeIn 0.5s; }
        
        #chartDiv { width: 100%; max-width: 600px; height: 600px; margin: 20px auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        /* SCHEMES STYLES */
        .schemes-container { display: flex; flex-direction: column; gap: 20px; justify-content: center; margin-bottom: 30px; }
        .scheme-box { background: var(--card); padding: 15px; border-radius: 10px; width: 100%; }
        .scheme-box.full-width { width: 100%; }
        .transit-block { margin-top: 15px; padding: 12px; border: 1px solid #333; border-radius: 10px; background: rgba(255,255,255,0.02); }
        .transit-block h3 { margin-top: 0; color: #ffd700; font-size: 15px; }
        
        /* Planet Table */
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th, .data-table td { padding: 8px; text-align: left; border-bottom: 1px solid #333; }
        .data-table th { color: #888; font-weight: normal; }
        .data-table td:first-child { font-weight: bold; color: #ffd700; }
        .transit-cell { color: #ff7575; text-align: center; }
        
        /* Aspect Matrix */
        .aspect-matrix-wrapper { overflow: auto; margin-top: 10px; width: 100%; }
        .aspect-matrix-table { border-collapse: collapse; width: 100%; min-width: 100%; background: #0f1424; }
        .aspect-matrix-table th,
        .aspect-matrix-table td { border: 1px solid #333; width: 32px; height: 32px; text-align: center; font-size: 12px; color: #ddd; }
        .aspect-matrix-table th { background: #1f1f35; font-weight: normal; }
        .matrix-icon { font-size: 16px; color: #ffd700; display: block; }
        .matrix-symbol { font-size: 15px; font-weight: bold; display: block; }
        .matrix-empty { background: rgba(255,255,255,0.02); }
        .asp-conj { color: #4fc3f7; }
        .asp-sextile { color: #00c853; }
        .asp-square { color: #ff5555; }
        .asp-trine { color: #d4e157; }
        .asp-opposition { color: #ff9100; }
        .asp-quincunx { color: #26c6da; }
        .aspect-legend { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; font-size: 12px; color: #bbb; margin-top: 15px; }
        .aspect-legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-symbol { font-weight: bold; font-size: 14px; }
        .legend-retro { color: #ff5555; }
        .transit-meta { text-align: center; color: #bbb; font-size: 12px; margin-top: 8px; }

        /* Orbs Settings */
        .orbs-block { margin-top: 15px; border: 1px solid #333; border-radius: 10px; overflow: hidden; }
        .orbs-header { background: rgba(255,255,255,0.05); padding: 12px 15px; cursor: pointer; }
        .orbs-header h3 { margin: 0; font-size: 14px; color: #888; display: flex; justify-content: space-between; align-items: center; }
        .orbs-header:hover { background: rgba(255,255,255,0.08); }
        .orbs-settings { padding: 15px; background: rgba(0,0,0,0.2); }
        .orbs-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        @media (max-width: 600px) { .orbs-grid { grid-template-columns: repeat(2, 1fr); } }
        .orb-item label { font-size: 11px; color: #888; display: block; margin-bottom: 4px; }
        .orb-item input { width: 100%; padding: 8px; background: var(--card); border: 1px solid #444; color: white; border-radius: 6px; text-align: center; font-size: 14px; }
        .reset-orbs-btn { margin-top: 12px; padding: 8px 16px; background: #444; border: none; color: #aaa; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .reset-orbs-btn:hover { background: #555; }

        /* Afetics (Planet Strength) */
        .afetic-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 6px; }
        .afetic-positive { background: #1b5e20; color: #a5d6a7; }
        .afetic-negative { background: #b71c1c; color: #ef9a9a; }
        .afetic-neutral { background: #37474f; color: #90a4ae; }
        .dignity-badge { font-size: 10px; color: #ffd54f; margin-left: 4px; }
        
        /* Interactive Aspects */
        .aspect-highlight { background: rgba(255,215,0,0.15) !important; }
        .planet-highlight { color: #ffd700 !important; text-shadow: 0 0 8px #ffd700; }

        /* Texts */
        .text-section { margin-top: 40px; }
        .planet-text-block { background: var(--card); padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid var(--accent); }
        .planet-text-header { font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #ffd700; display: flex; align-items: center; }
        .planet-text-header span { margin-right: 10px; font-size: 20px; }
        .planet-text-body { font-size: 14px; line-height: 1.6; color: #ddd; white-space: pre-wrap; }

        /* Suggestions */
        .suggestions { position: absolute; background: #222; width: 100%; max-height: 200px; overflow-y: auto; z-index: 100; border: 1px solid #444; border-radius: 0 0 8px 8px; display: none; top: 100%; }
        .suggestion-item { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; }
        .suggestion-item:hover { background: #333; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .error-msg { color: #ff4444; text-align: center; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåå –ù–∞—Ç–∞–ª—å–Ω–∞—è –ö–∞—Ä—Ç–∞</h1>
        
        <div id="form">
            <div class="form-grid">
                <div class="input-group"><label>–ò–º—è</label><input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è" value="–ü–∞–≤–µ–ª"></div>
                <div class="input-group">
                    <label>–ü–æ–ª</label>
                    <div class="row" style="gap: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: white;">
                            <input type="radio" name="gender" value="male" checked style="width: auto; margin: 0;"> ‚ôÇ –ú—É–∂—Å–∫–æ–π
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; color: white;">
                            <input type="radio" name="gender" value="female" style="width: auto; margin: 0;"> ‚ôÄ –ñ–µ–Ω—Å–∫–∏–π
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="form-grid">
                <div>
                    <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <div class="row">
                        <input type="number" id="day" placeholder="–î–î" class="col" value="13">
                        <input type="number" id="month" placeholder="–ú–ú" class="col" value="10">
                        <input type="number" id="year" placeholder="–ì–ì–ì–ì" class="col" style="flex: 1.5;" value="1992">
                    </div>
                </div>
                <div>
                    <label>–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <div class="row">
                        <input type="number" id="hour" placeholder="–ß–ß" class="col" value="9">
                        <input type="number" id="minute" placeholder="–ú–ú" class="col" value="35">
                    </div>
                </div>
            </div>

            <div class="transit-block">
                <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç—Ä–∞–Ω–∑–∏—Ç–∞</h3>
                <div class="form-grid">
                    <div>
                        <label>–î–∞—Ç–∞ —Ç—Ä–∞–Ω–∑–∏—Ç–∞</label>
                        <div class="row">
                            <input type="number" id="t_day" placeholder="–î–î" class="col">
                            <input type="number" id="t_month" placeholder="–ú–ú" class="col">
                            <input type="number" id="t_year" placeholder="–ì–ì–ì–ì" class="col" style="flex: 1.5;">
                        </div>
                    </div>
                    <div>
                        <label>–í—Ä–µ–º—è —Ç—Ä–∞–Ω–∑–∏—Ç–∞</label>
                        <div class="row">
                            <input type="number" id="t_hour" placeholder="–ß–ß" class="col">
                            <input type="number" id="t_minute" placeholder="–ú–ú" class="col">
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ä–±–∏—Å–æ–≤ -->
            <div class="orbs-block">
                <div class="orbs-header" onclick="toggleOrbs()">
                    <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ä–±–∏—Å–æ–≤ <span id="orbsToggle">‚ñº</span></h3>
                </div>
                <div id="orbsSettings" class="orbs-settings" style="display: none;">
                    <div class="orbs-grid">
                        <div class="orb-item">
                            <label>‚òå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (0¬∞)</label>
                            <input type="number" id="orb_conj" value="8" min="1" max="15">
                        </div>
                        <div class="orb-item">
                            <label>‚ú∂ –°–µ–∫—Å—Ç–∏–ª—å (60¬∞)</label>
                            <input type="number" id="orb_sext" value="6" min="1" max="12">
                        </div>
                        <div class="orb-item">
                            <label>‚ñ° –ö–≤–∞–¥—Ä–∞—Ç (90¬∞)</label>
                            <input type="number" id="orb_sqr" value="8" min="1" max="12">
                        </div>
                        <div class="orb-item">
                            <label>‚ñ≥ –¢—Ä–∏–≥–æ–Ω (120¬∞)</label>
                            <input type="number" id="orb_tri" value="8" min="1" max="12">
                        </div>
                        <div class="orb-item">
                            <label>‚§ª –ö–≤–∏–Ω–∫–æ–Ω—Å (150¬∞)</label>
                            <input type="number" id="orb_quin" value="4" min="1" max="8">
                        </div>
                        <div class="orb-item">
                            <label>‚òç –û–ø–ø–æ–∑–∏—Ü–∏—è (180¬∞)</label>
                            <input type="number" id="orb_opp" value="8" min="1" max="12">
                        </div>
                    </div>
                    <button type="button" onclick="resetOrbs()" class="reset-orbs-btn">–°–±—Ä–æ—Å–∏—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</button>
                </div>
            </div>

            <div class="input-group" style="margin-top: 15px;">
                <label>–ì–æ—Ä–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                <input type="text" id="city" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å..." oninput="suggestCity()" autocomplete="off" value="–ì—Ä–æ–∑–Ω—ã–π">
                <div class="suggestions" id="suggestions"></div>
                <input type="hidden" id="lat" value="43.31695"><input type="hidden" id="lon" value="45.68365">
            </div>
            
            <button onclick="calculate()" id="calcBtn">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–∞—Ä—Ç—É</button>
            <div id="errorMsg" class="error-msg"></div>
        </div>

        <div id="result" class="result-section">
            <h2 style="text-align:center">–ö–∞—Ä—Ç–∞ –¥–ª—è: <span id="resName" style="color: var(--accent)"></span></h2>
            <div style="text-align: center; color: #888; font-size: 14px; margin-bottom: 20px;">
                <span id="resCity"></span> ‚Ä¢ <span id="resTime"></span>
            </div>

            <!-- 1. CHART VISUAL -->
            <div id="chartDiv"></div>
            
            <!-- 2. SCHEMES (TABLES) -->
            <div class="schemes-container">
                <!-- Aspects Matrix -->
                <div class="scheme-box full-width">
                    <h3 style="text-align:center; margin-top:0">‚ú® –ú–∞—Ç—Ä–∏—Ü–∞ –∞—Å–ø–µ–∫—Ç–æ–≤</h3>
                    <div class="aspect-matrix-wrapper">
                        <table id="aspectMatrixTable" class="aspect-matrix-table"></table>
                    </div>
                    <div id="transitMeta" class="transit-meta"></div>
                    <div class="aspect-legend">
                        <div class="aspect-legend-item"><span class="legend-symbol asp-conj">‚óè</span>- –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ 0¬∞ (–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π)</div>
                        <div class="aspect-legend-item"><span class="legend-symbol asp-sextile">‚ú∂</span>- –°–µ–∫—Å—Ç–∏–ª—å 60¬∞ (–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π)</div>
                        <div class="aspect-legend-item"><span class="legend-symbol asp-trine">‚ñ≥</span>- –¢—Ä–∏–≥–æ–Ω 120¬∞ (–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π)</div>
                        <div class="aspect-legend-item"><span class="legend-symbol asp-quincunx">‚§ª</span>- –ö–≤–∏–Ω–∫–æ–Ω—Å 150¬∞ (–ì–∞—Ä–º–æ–Ω–∏—á–Ω—ã–π)</div>
                        <div class="aspect-legend-item"><span class="legend-symbol asp-square">‚ñ°</span>- –ö–≤–∞–¥—Ä–∞—Ç 90¬∞ (–ù–∞–ø—Ä—è–∂—ë–Ω–Ω—ã–π)</div>
                        <div class="aspect-legend-item"><span class="legend-symbol asp-opposition">‚òç</span>- –û–ø–ø–æ–∑–∏—Ü–∏—è 180¬∞ (–ù–∞–ø—Ä—è–∂—ë–Ω–Ω—ã–π)</div>
                        <div class="aspect-legend-item"><span class="legend-symbol legend-retro">R</span>- –†–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω—ã–π</div>
                    </div>
                </div>

                <!-- Planets Table with Afetics -->
                <div class="scheme-box">
                    <h3 style="text-align:center; margin-top:0">ü™ê –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –°–∏–ª–∞ –ø–ª–∞–Ω–µ—Ç</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>–ü–ª–∞–Ω–µ—Ç—ã</th>
                                <th>–ù–∞—Ç–∞–ª—å–Ω–∞—è –¥–æ–ª–≥–æ—Ç–∞</th>
                                <th>–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–æ–ª–≥–æ—Ç–∞</th>
                                <th style="text-align:center">–°–∏–ª–∞</th>
                            </tr>
                        </thead>
                        <tbody id="planetsTableBody"></tbody>
                    </table>
                    <div style="margin-top: 10px; font-size: 11px; color: #888;">
                        <b>–°–∏–ª–∞:</b> –ë–∞–ª–ª—ã –∞—Ñ–µ—Ç–∏–∫–∏ (–¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞ + –¥–æ–º–∞ + –∞—Å–ø–µ–∫—Ç—ã). 
                        <span style="color:#a5d6a7">–ó–µ–ª–µ–Ω—ã–π</span> = —Å–∏–ª—å–Ω–∞—è, 
                        <span style="color:#ef9a9a">–∫—Ä–∞—Å–Ω—ã–π</span> = —Å–ª–∞–±–∞—è.
                    </div>
                </div>
            </div>
            
            <!-- 3. TEXTS -->
            <div class="text-section">
                <h3 style="text-align:center; margin-bottom:30px;">üìñ –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</h3>
                <div id="textsList"></div>
            </div>
            
            <button onclick="downloadPDF()" style="background: #444; margin-bottom: 50px; margin-top: 30px;">üìÑ –°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç</button>
        </div>
    </div>

    <script>
        // ... (Telegram & Focus logic same as before) ...
        // Init Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        // Auto-focus logic
        ['day', 'month', 'year', 'hour', 'minute'].forEach((id, i, arr) => {
            document.getElementById(id).addEventListener('input', function() {
                if(this.value.length >= this.getAttribute('placeholder').length && i < arr.length-1) {
                    document.getElementById(arr[i+1]).focus();
                }
            });
        });

        function setDefaultTransitFields() {
            const now = new Date();
            document.getElementById('t_day').value = now.getDate();
            document.getElementById('t_month').value = now.getMonth() + 1;
            document.getElementById('t_year').value = now.getFullYear();
            document.getElementById('t_hour').value = now.getHours();
            document.getElementById('t_minute').value = now.getMinutes();
        }
        window.addEventListener('load', setDefaultTransitFields);

        // Orbs toggle
        function toggleOrbs() {
            const settings = document.getElementById('orbsSettings');
            const toggle = document.getElementById('orbsToggle');
            if (settings.style.display === 'none') {
                settings.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                settings.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }

        function resetOrbs() {
            document.getElementById('orb_conj').value = 8;
            document.getElementById('orb_sext').value = 6;
            document.getElementById('orb_sqr').value = 8;
            document.getElementById('orb_tri').value = 8;
            document.getElementById('orb_quin').value = 4;
            document.getElementById('orb_opp').value = 8;
        }

        function getOrbValues() {
            return {
                orb_conjunction: parseInt(document.getElementById('orb_conj').value) || null,
                orb_sextile: parseInt(document.getElementById('orb_sext').value) || null,
                orb_square: parseInt(document.getElementById('orb_sqr').value) || null,
                orb_trine: parseInt(document.getElementById('orb_tri').value) || null,
                orb_quincunx: parseInt(document.getElementById('orb_quin').value) || null,
                orb_opposition: parseInt(document.getElementById('orb_opp').value) || null
            };
        }

        // City Search
        let timer;
        function suggestCity() {
            clearTimeout(timer);
            const val = document.getElementById('city').value;
            const list = document.getElementById('suggestions');
            if(val.length < 3) { list.style.display='none'; return; }
            
            timer = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&accept_language=ru`);
                    const data = await res.json();
                    list.innerHTML = '';
                    if(data.length) {
                        list.style.display = 'block';
                        data.slice(0, 5).forEach(p => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.textContent = p.display_name.split(',').slice(0,3).join(', ');
                            div.onclick = () => {
                                document.getElementById('city').value = p.display_name.split(',')[0];
                                document.getElementById('lat').value = p.lat;
                                document.getElementById('lon').value = p.lon;
                                list.style.display = 'none';
                            }
                            list.appendChild(div);
                        });
                    }
                } catch(e) { console.error(e); }
            }, 500);
        }

        // Close suggestions on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-group')) {
                document.getElementById('suggestions').style.display = 'none';
            }
        });

        // Main Calculation
        async function calculate() {
            const btn = document.getElementById('calcBtn');
            const errorDiv = document.getElementById('errorMsg');
            
            // Basic validation
            const required = ['day', 'month', 'year', 'hour', 'minute', 'city', 't_day', 't_month', 't_year', 't_hour', 't_minute'];
            for (let id of required) {
                if (!document.getElementById(id).value) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                    return;
                }
            }

            btn.innerHTML = "‚è≥ –í—ã—á–∏—Å–ª—è—é...";
            btn.disabled = true;
            errorDiv.style.display = 'none';
            document.getElementById('result').style.display = 'none';
            
            const orbValues = getOrbValues();
            const genderRadio = document.querySelector('input[name="gender"]:checked');
            const data = {
                name: document.getElementById('name').value || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                gender: genderRadio ? genderRadio.value : "male",
                year: parseInt(document.getElementById('year').value),
                month: parseInt(document.getElementById('month').value),
                day: parseInt(document.getElementById('day').value),
                hour: parseInt(document.getElementById('hour').value),
                minute: parseInt(document.getElementById('minute').value),
                city: document.getElementById('city').value,
                lat: parseFloat(document.getElementById('lat').value) || null,
                lon: parseFloat(document.getElementById('lon').value) || null,
                transit_year: parseInt(document.getElementById('t_year').value),
                transit_month: parseInt(document.getElementById('t_month').value),
                transit_day: parseInt(document.getElementById('t_day').value),
                transit_hour: parseInt(document.getElementById('t_hour').value),
                transit_minute: parseInt(document.getElementById('t_minute').value),
                ...orbValues
            };

            try {
                const res = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }

                renderResult(result);
            } catch (e) {
                errorDiv.textContent = "–û—à–∏–±–∫–∞: " + e.message;
                errorDiv.style.display = 'block';
            } finally {
                btn.innerHTML = "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–∞—Ä—Ç—É";
                btn.disabled = false;
            }
        }

        function renderResult(data) {
            document.getElementById('result').style.display = 'block';
            document.getElementById('resName').textContent = data.name;
            document.getElementById('resCity').textContent = data.meta.city;
            document.getElementById('resTime').textContent = data.meta.dt;
            const transitInfo = document.getElementById('transitMeta');
            if (transitInfo) {
                transitInfo.textContent = data.transit_meta ? `–¢—Ä–∞–Ω–∑–∏—Ç –Ω–∞ ${data.transit_meta.dt}` : '';
            }
            
            // 1. Planets Table
            const tBody = document.getElementById('planetsTableBody');
            tBody.innerHTML = '';
            const textContainer = document.getElementById('textsList');
            textContainer.innerHTML = '';

            const transits = data.transits || [];
            const transitMap = {};
            transits.forEach(p => { if (p.key) transitMap[p.key] = p; });

            const formatNatalPos = (planet) => {
                if (!planet) return '‚Äî';
                const deg = Math.floor(planet.pos);
                const min = Math.round((planet.pos % 1) * 60);
                return `${planet.sign} ${deg}¬∞${min.toString().padStart(2,'0')}'`;
            };
            const formatTransitPos = (planet) => {
                if (!planet) return '‚Äî';
                const abs = (planet.abs_pos || 0) % 360;
                const signs = ['–û–≤–µ–Ω','–¢–µ–ª–µ—Ü','–ë–ª–∏–∑–Ω–µ—Ü—ã','–†–∞–∫','–õ–µ–≤','–î–µ–≤–∞','–í–µ—Å—ã','–°–∫–æ—Ä–ø–∏–æ–Ω','–°—Ç—Ä–µ–ª–µ—Ü','–ö–æ–∑–µ—Ä–æ–≥','–í–æ–¥–æ–ª–µ–π','–†—ã–±—ã'];
                const idx = Math.floor(abs / 30);
                const local = abs % 30;
                const min = Math.round((local % 1) * 60);
                return `${signs[idx]} ${Math.floor(local)}¬∞${min.toString().padStart(2,'0')}'`;
            };

            data.planets.forEach(p => {
                const retro = p.is_retro ? '<span style="color:red; font-size:10px; vertical-align:super;">R</span>' : '';
                
                // –ê—Ñ–µ—Ç–∏–∫–∞
                let afeticHtml = '';
                if (p.afetic_score !== undefined && p.key !== 'ASC' && p.key !== 'MC') {
                    const score = p.afetic_score;
                    let badgeClass = 'afetic-neutral';
                    if (score >= 3) badgeClass = 'afetic-positive';
                    else if (score <= -3) badgeClass = 'afetic-negative';
                    afeticHtml = `<span class="afetic-badge ${badgeClass}">${score > 0 ? '+' : ''}${score}</span>`;
                    if (p.dignity) {
                        afeticHtml += `<span class="dignity-badge">${p.dignity}</span>`;
                    }
                }
                
                tBody.innerHTML += `
                    <tr class="planet-row" data-planet="${p.key}">
                        <td style="color:${p.key==='ASC'||p.key==='MC'?'#ff5555':'#ffd700'}; display:flex; align-items:center; gap:8px;">
                            <span>${p.icon}</span><span>${p.name} ${retro}</span>
                        </td>
                        <td>${formatNatalPos(p)}</td>
                        <td class="transit-cell">${formatTransitPos(transitMap[p.key])}</td>
                        <td style="text-align:center">${afeticHtml}</td>
                    </tr>`;

                // Text Block
                if(p.text && p.key !== 'ASC' && p.key !== 'MC') {
                    textContainer.innerHTML += `
                        <div class="planet-text-block">
                            <div class="planet-text-header">
                                <span>${p.icon}</span> ${p.name} –≤ –∑–Ω–∞–∫–µ ${p.sign}, ${p.house} –¥–æ–º
                            </div>
                            <div class="planet-text-body">${p.text}</div>
                        </div>`;
                }
            });

            // 2. Aspect Matrix
            const matrixTransits = transits.length ? transits : data.planets;
            const matrixAspects = transits.length ? (data.transit_aspects || []) : (data.aspects || []);
            renderAspectMatrix(data.planets, matrixTransits, matrixAspects);

            // Also Text descriptions
            data.aspects.forEach(a => {
                let color = "#ccc";
                if (a.type === "Square" || a.type === "Opposition") color = "#ff5555";
                if (a.type === "Trine") color = "#8bc34a";
                if (a.type === "Sextile") color = "#4dd0e1";
                if (a.type === "Quincunx") color = "#26c6da";
                
                let symbol = "‚óè";
                if(a.type === "Conjunction") symbol = "‚òå";
                if(a.type === "Sextile") symbol = "‚ú∂";
                if(a.type === "Square") symbol = "‚ñ°";
                if(a.type === "Trine") symbol = "‚ñ≥";
                if(a.type === "Opposition") symbol = "‚òç";
                if(a.type === "Quincunx") symbol = "‚§ª";

                const nameLabel = a.name || a.type;

                textContainer.innerHTML += `
                    <div class="planet-text-block" style="border-left-color: ${color}">
                        <div class="planet-text-header">
                            <span style="color:${color}">${symbol}</span> ${a.p1} ‚Äî ${a.p2} (${nameLabel})
                        </div>
                        <div class="planet-text-body">${a.text || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                    </div>`;
            });

            // 3. Draw Chart
            try {
                drawChart(data.planets, data.houses, data.aspects);
            } catch (e) {
                console.error("Chart error:", e);
                document.getElementById('chartDiv').innerHTML = "<p style='color:black; text-align:center; padding:20px;'>–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫—É</p>";
            }
            
            setTimeout(() => {
                document.getElementById('result').scrollIntoView({behavior: 'smooth'});
            }, 100);
        }
        
        function drawChart(planets, cusps, aspects) {
            const container = document.getElementById('chartDiv');
            const size = Math.min(container.clientWidth, 600) || 400;
            
            // Ensure container has height
            container.style.height = size + "px";

            const chart = new NatalChart('chartDiv', size);
            chart.draw({
                planets: planets,
                houses: cusps,
                aspects: aspects
            });
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∞—Å–ø–µ–∫—Ç–æ–≤ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        let globalAspects = [];
        let globalPlanets = [];

        function renderAspectMatrix(natalPlanets, transitPlanets, transitAspects) {
            const table = document.getElementById('aspectMatrixTable');
            if (!table) return;
            table.innerHTML = '';

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            globalAspects = transitAspects;
            globalPlanets = natalPlanets;

            const planetsOrder = [
                { key: 'Sun', icon: '‚òâ' },
                { key: 'Moon', icon: '‚òæ' },
                { key: 'Mercury', icon: '‚òø' },
                { key: 'Venus', icon: '‚ôÄ' },
                { key: 'Mars', icon: '‚ôÇ' },
                { key: 'Jupiter', icon: '‚ôÉ' },
                { key: 'Saturn', icon: '‚ôÑ' },
                { key: 'Uranus', icon: '‚ôÖ' },
                { key: 'Neptune', icon: '‚ôÜ' },
                { key: 'Pluto', icon: '‚ôá' },
                { key: 'Lilith', icon: '‚ö∏' },
                { key: 'North_node', icon: '‚òä' },
                { key: 'South_node', icon: '‚òã' },
                { key: 'ASC', icon: 'AC' },
                { key: 'MC', icon: 'MC' }
            ];

            const natalMap = {};
            natalPlanets.forEach(p => { if (p.key) natalMap[p.key] = p; });
            const transitMap = {};
            transitPlanets.forEach(p => { if (p.key) transitMap[p.key] = p; });

            const aspectMap = {};
            transitAspects.forEach(a => {
                if (a.p1_key && a.p2_key) {
                    aspectMap[`${a.p1_key}_${a.p2_key}`] = a;
                }
            });

            const symbols = {
                Conjunction: { char: '‚óè', cls: 'asp-conj' },
                Sextile: { char: '‚ú∂', cls: 'asp-sextile' },
                Square: { char: '‚ñ°', cls: 'asp-square' },
                Trine: { char: '‚ñ≥', cls: 'asp-trine' },
                Opposition: { char: '‚òç', cls: 'asp-opposition' },
                Quincunx: { char: '‚§ª', cls: 'asp-quincunx' }
            };

            const headerRow = document.createElement('tr');
            const cornerTh = document.createElement('th');
            cornerTh.textContent = '‚Üì–ù–∞—Ç / –¢—Ä‚Üí';
            cornerTh.style.fontSize = '9px';
            headerRow.appendChild(cornerTh);
            planetsOrder.forEach((pl, colIdx) => {
                const th = document.createElement('th');
                th.innerHTML = `<span class="matrix-icon" data-col="${colIdx}" data-planet="${pl.key}">${pl.icon}</span>`;
                th.dataset.planet = pl.key;
                th.classList.add('matrix-header-cell');
                // Hover –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∫–æ–ª–æ–Ω–∫–∏
                th.addEventListener('mouseenter', () => highlightPlanetAspects(pl.key, 'col'));
                th.addEventListener('mouseleave', clearHighlights);
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            planetsOrder.forEach((rowPl, rowIdx) => {
                const tr = document.createElement('tr');
                tr.dataset.planet = rowPl.key;
                const header = document.createElement('th');
                header.innerHTML = `<span class="matrix-icon">${rowPl.icon}</span>`;
                header.classList.add('matrix-header-cell');
                header.dataset.planet = rowPl.key;
                // Hover –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–µ —Å—Ç—Ä–æ–∫–∏
                header.addEventListener('mouseenter', () => highlightPlanetAspects(rowPl.key, 'row'));
                header.addEventListener('mouseleave', clearHighlights);
                tr.appendChild(header);

                planetsOrder.forEach((colPl, colIdx) => {
                    const td = document.createElement('td');
                    td.dataset.row = rowPl.key;
                    td.dataset.col = colPl.key;
                    const natalPlanet = natalMap[rowPl.key];
                    const transitPlanet = transitMap[colPl.key];
                    if (!natalPlanet || !transitPlanet) {
                        td.classList.add('matrix-empty');
                    } else {
                        const aspect = aspectMap[`${natalPlanet.key}_${transitPlanet.key}`];
                        if (aspect) {
                            const sym = symbols[aspect.type] || symbols.Conjunction;
                            td.innerHTML = `<span class="matrix-symbol ${sym.cls}">${sym.char}</span>`;
                            td.title = `${aspect.p1} ${aspect.name} ${aspect.p2} (–æ—Ä–±–∏—Å: ${aspect.orb}¬∞)`;
                            // Hover –Ω–∞ —è—á–µ–π–∫–µ –∞—Å–ø–µ–∫—Ç–∞
                            td.addEventListener('mouseenter', () => highlightAspectCell(rowPl.key, colPl.key, aspect));
                            td.addEventListener('mouseleave', clearHighlights);
                        } else {
                            td.classList.add('matrix-empty');
                        }
                    }
                    tr.appendChild(td);
                });

                table.appendChild(tr);
            });
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞—Å–ø–µ–∫—Ç–æ–≤ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –ø–ª–∞–Ω–µ—Ç—É
        function highlightPlanetAspects(planetKey, direction) {
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—Å–µ —è—á–µ–π–∫–∏ —Å —ç—Ç–æ–π –ø–ª–∞–Ω–µ—Ç–æ–π
            const table = document.getElementById('aspectMatrixTable');
            if (!table) return;

            const cells = table.querySelectorAll('td');
            cells.forEach(cell => {
                if (direction === 'row' && cell.dataset.row === planetKey) {
                    cell.classList.add('aspect-highlight');
                } else if (direction === 'col' && cell.dataset.col === planetKey) {
                    cell.classList.add('aspect-highlight');
                }
            });

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø–ª–∞–Ω–µ—Ç—É –≤ —Ç–∞–±–ª–∏—Ü–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
            const planetRows = document.querySelectorAll('.planet-row');
            planetRows.forEach(row => {
                if (row.dataset.planet === planetKey) {
                    row.classList.add('aspect-highlight');
                }
            });

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ª–∏–Ω–∏–∏ –∞—Å–ø–µ–∫—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ SVG
            highlightChartAspects(planetKey);
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —è—á–µ–π–∫–∏ –∞—Å–ø–µ–∫—Ç–∞
        function highlightAspectCell(rowKey, colKey, aspect) {
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –æ–±–µ –ø–ª–∞–Ω–µ—Ç—ã
            const planetRows = document.querySelectorAll('.planet-row');
            planetRows.forEach(row => {
                if (row.dataset.planet === rowKey || row.dataset.planet === colKey) {
                    row.classList.add('aspect-highlight');
                }
            });

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ª–∏–Ω–∏—é –∞—Å–ø–µ–∫—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
            highlightSpecificAspect(aspect.p1, aspect.p2);
        }

        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏
        function clearHighlights() {
            document.querySelectorAll('.aspect-highlight').forEach(el => {
                el.classList.remove('aspect-highlight');
            });
            document.querySelectorAll('.planet-highlight').forEach(el => {
                el.classList.remove('planet-highlight');
            });
            // –°–±—Ä–æ—Å –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –Ω–∞ SVG
            resetChartHighlights();
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞—Å–ø–µ–∫—Ç–æ–≤ –Ω–∞ SVG –∫–∞—Ä—Ç–µ
        function highlightChartAspects(planetKey) {
            const svg = document.querySelector('#chartDiv svg');
            if (!svg) return;
            
            const lines = svg.querySelectorAll('line');
            lines.forEach(line => {
                // –ê—Å–ø–µ–∫—Ç–Ω—ã–µ –ª–∏–Ω–∏–∏ –æ–±—ã—á–Ω–æ –∏–º–µ—é—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ —Ü–≤–µ—Ç–∞
                const stroke = line.getAttribute('stroke');
                if (stroke && ['#ff5252', '#4caf50', '#29b6f6', '#ff9800'].includes(stroke)) {
                    line.style.opacity = '0.3';
                }
            });

            // –ù–∞—Ö–æ–¥–∏–º –∞—Å–ø–µ–∫—Ç—ã —Å —ç—Ç–æ–π –ø–ª–∞–Ω–µ—Ç–æ–π –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∏—Ö
            globalAspects.forEach(asp => {
                if (asp.p1_key === planetKey || asp.p2_key === planetKey) {
                    // –ò—â–µ–º –ª–∏–Ω–∏—é —ç—Ç–æ–≥–æ –∞—Å–ø–µ–∫—Ç–∞ (–ø–æ –ø–æ–∑–∏—Ü–∏–∏)
                    // –≠—Ç–æ —Å–ª–æ–∂–Ω–æ –±–µ–∑ ID, –ø–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—Å–µ
                }
            });
        }

        function highlightSpecificAspect(p1Name, p2Name) {
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞—Å–ø–µ–∫—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
            const svg = document.querySelector('#chartDiv svg');
            if (!svg) return;
            
            const lines = svg.querySelectorAll('line');
            lines.forEach(line => {
                const stroke = line.getAttribute('stroke');
                if (stroke && ['#ff5252', '#4caf50', '#29b6f6', '#ff9800'].includes(stroke)) {
                    line.style.opacity = '0.2';
                }
            });
        }

        function resetChartHighlights() {
            const svg = document.querySelector('#chartDiv svg');
            if (!svg) return;
            
            const lines = svg.querySelectorAll('line');
            lines.forEach(line => {
                line.style.opacity = '1';
            });
        }

        function downloadPDF() {
            const name = document.getElementById('name').value;
            const btn = event.target;
            btn.innerHTML = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
            
            const link = document.createElement('a');
            link.href = `/api/pdf?name=${encodeURIComponent(name)}`;
            link.download = `Horoscope_${name}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            setTimeout(() => btn.innerHTML = "üìÑ –°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç", 2000);
        }
    </script>
</body>
</html>