<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–∞–Ω–∑–∏—Ç—ã. –û–Ω–ª–∞–π–Ω —Ä–∞—Å—á–µ—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/static/chart.js?v=10"></script>
    <style>
        :root {
            --bg: #000;
            --card: rgba(29, 29, 31, 0.8);
            --text: #f5f5f7;
            --text-secondary: #86868b;
            --accent: #bf5af2;
            --accent-2: #5e5ce6;
            --border: rgba(255,255,255,0.08);
            --input-bg: rgba(0,0,0,0.4);
        }
        
        * { box-sizing: border-box; }
        
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 720px;
            margin: 0 auto;
            padding: 40px 24px;
        }
        
        h1 {
            text-align: center;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
            background: linear-gradient(180deg, #fff 0%, rgba(255,255,255,0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 40px;
        }

        /* Form */
        .form-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--card);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .form-table tr { border-bottom: 1px solid var(--border); }
        .form-table tr:last-child { border-bottom: none; }
        .form-table td { padding: 16px 20px; vertical-align: middle; }
        .form-table td:first-child { color: var(--text-secondary); width: 180px; font-size: 14px; font-weight: 500; }
        
        .form-table input, .form-table select {
            padding: 12px 14px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.2s;
        }
        
        .form-table input:focus, .form-table select:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(191, 90, 242, 0.2);
        }
        
        .form-table input[type="number"] { width: 75px; text-align: center; }
        .form-table input.year-input { width: 90px; }
        .form-table input.city-input { width: 100%; max-width: 280px; }
        .form-table select { 
            background: var(--input-bg); 
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2386868b' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .separator { color: var(--text-secondary); margin: 0 4px; }
        .coords { color: var(--text-secondary); font-size: 12px; margin-top: 8px; }

        /* Calculate Button */
        .calc-btn {
            display: block;
            width: 100%;
            max-width: 320px;
            margin: 32px auto;
            padding: 18px 32px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-2) 100%);
            color: #fff;
            border: none;
            border-radius: 980px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            letter-spacing: -0.01em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .calc-btn:hover {
            transform: scale(1.03);
            box-shadow: 0 12px 40px rgba(191, 90, 242, 0.4);
        }
        
        .calc-btn:disabled { opacity: 0.5; cursor: wait; transform: none; }

        /* Suggestions */
        .input-group { position: relative; }
        .suggestions {
            position: absolute;
            background: rgba(29, 29, 31, 0.98);
            backdrop-filter: blur(20px);
            width: 100%;
            max-width: 280px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            border: 1px solid var(--border);
            border-radius: 12px;
            display: none;
            top: calc(100% + 4px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .suggestion-item { padding: 14px 16px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 14px; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background: rgba(255,255,255,0.05); }

        /* Results */
        .result-section { display: none; margin-top: 40px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 24px 0;
            background: var(--card);
            padding: 6px;
            border-radius: 12px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }
        
        .mode-tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .mode-tab:hover { color: var(--text); }
        .mode-tab.active { background: var(--accent); color: #fff; }

        /* Chart */
        #chartDiv {
            background: var(--card);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin: 24px auto;
            max-width: 600px;
        }

        /* View Tabs */
        .view-tabs {
            display: flex;
            justify-content: center;
            margin: 24px auto;
            background: var(--card);
            padding: 4px;
            border-radius: 10px;
            width: fit-content;
        }
        
        .view-tab {
            padding: 10px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .view-tab:hover { color: var(--text); }
        .view-tab.active { background: rgba(255,255,255,0.1); color: var(--text); }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--card);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            font-size: 14px;
        }
        
        .data-table th {
            background: rgba(255,255,255,0.03);
            color: var(--text-secondary);
            font-weight: 500;
            text-align: left;
            padding: 14px 16px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .data-table td { padding: 14px 16px; border-top: 1px solid var(--border); }
        .data-table tr:hover td { background: rgba(255,255,255,0.02); }

        /* Aspect Matrix */
        .aspect-matrix-table {
            border-collapse: collapse;
            margin: 20px auto;
            font-size: 11px;
        }
        
        .aspect-matrix-table th, .aspect-matrix-table td {
            width: 32px;
            height: 32px;
            text-align: center;
            border: 1px solid var(--border);
            padding: 4px;
        }
        
        .aspect-matrix-table th { background: rgba(255,255,255,0.03); font-size: 12px; }
        .matrix-icon { font-size: 14px; }

        /* Planet Text Blocks */
        .planet-text-block {
            background: var(--card);
            backdrop-filter: blur(40px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
            border-left: 3px solid var(--accent);
        }
        
        .planet-text-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text);
        }
        
        .planet-text-body {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        /* Extra Settings */
        .extra-settings {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
        }
        
        .extra-settings h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text);
        }
        
        .extra-settings button {
            padding: 10px 20px;
            background: var(--accent);
            border: none;
            color: #fff;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .extra-settings button:hover { opacity: 0.9; }

        /* Aspect Legend */
        .aspect-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            margin: 20px 0;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Result Header */
        .result-name { color: var(--accent); font-size: 28px; font-weight: 700; }
        .result-info { color: var(--text-secondary); font-size: 14px; margin: 8px 0; }
        #resTransit { color: #ffd700; font-weight: 500; }

        /* Error */
        .error-msg {
            background: rgba(255, 59, 48, 0.15);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: #ff453a;
            padding: 16px 20px;
            border-radius: 12px;
            margin-top: 16px;
            display: none;
            font-size: 14px;
        }

        /* Buttons */
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .action-btn:hover { background: rgba(255,255,255,0.08); }

        /* Radio/Checkbox */
        input[type="radio"] {
            accent-color: var(--accent);
            width: 18px;
            height: 18px;
        }

        /* Section Title */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin: 32px 0 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .container { padding: 24px 16px; }
            h1 { font-size: 24px; }
            .form-table td:first-child { display: block; width: 100%; padding-bottom: 8px; }
            .form-table td { display: block; padding: 12px 16px; }
            .form-table input.city-input { max-width: 100%; }
            .calc-btn { max-width: 100%; }
            #chartDiv { padding: 12px; }
            .data-table { font-size: 12px; }
            .data-table th, .data-table td { padding: 10px 12px; }
            .planet-text-block { padding: 16px; }
        }
</style>
</head>
<body>
    <div class="container">
        <h1>–¢—Ä–∞–Ω–∑–∏—Ç—ã. –û–Ω–ª–∞–π–Ω —Ä–∞—Å—á—ë—Ç</h1>
        <p class="subtitle">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç</p>

        <!-- INPUT FORM -->
        <div id="inputForm">
            <table class="form-table">
                <tr>
                    <td>–ò–º—è:</td>
                    <td><input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è" value=""></td>
                </tr>
                <tr>
                    <td>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</td>
                    <td>
                        <div class="row">
                            <input type="number" id="day" placeholder="–î–î" min="1" max="31">
                            <select id="month">
                                <option value="1">–Ø–Ω–≤–∞—Ä—è</option>
                                <option value="2">–§–µ–≤—Ä–∞–ª—è</option>
                                <option value="3">–ú–∞—Ä—Ç–∞</option>
                                <option value="4">–ê–ø—Ä–µ–ª—è</option>
                                <option value="5">–ú–∞—è</option>
                                <option value="6">–ò—é–Ω—è</option>
                                <option value="7">–ò—é–ª—è</option>
                                <option value="8">–ê–≤–≥—É—Å—Ç–∞</option>
                                <option value="9">–°–µ–Ω—Ç—è–±—Ä—è</option>
                                <option value="10">–û–∫—Ç—è–±—Ä—è</option>
                                <option value="11">–ù–æ—è–±—Ä—è</option>
                                <option value="12">–î–µ–∫–∞–±—Ä—è</option>
                            </select>
                            <span class="separator">,</span>
                            <input type="number" id="year" placeholder="–ì–ì–ì–ì" class="year-input" min="1900" max="2100">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>–í—Ä–µ–º—è —Ä–æ–∂–¥–µ–Ω–∏—è:</td>
                    <td>
                        <div class="row">
                            <input type="number" id="hour" placeholder="–ß–ß" min="0" max="23">
                            <span class="separator">:</span>
                            <input type="number" id="minute" placeholder="–ú–ú" min="0" max="59">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>–ú–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è:</td>
                    <td>
                        <div class="input-group">
                            <input type="text" id="city" class="city-input" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –≥–æ—Ä–æ–¥..." oninput="suggestCity()" autocomplete="off">
                            <div class="suggestions" id="suggestions"></div>
                        </div>
                        <div class="coords" id="coordsDisplay">–®–∏—Ä–æ—Ç–∞: ‚Äî, –î–æ–ª–≥–æ—Ç–∞: ‚Äî</div>
                        <input type="hidden" id="lat">
                        <input type="hidden" id="lon">
                    </td>
                </tr>
                <tr>
                    <td>–ü–æ–ª:</td>
                    <td>
                        <div class="row">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="radio" name="gender" value="male" checked> –ú—É–∂—Å–∫–æ–π
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; margin-left: 15px;">
                                <input type="radio" name="gender" value="female"> –ñ–µ–Ω—Å–∫–∏–π
                            </label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>–î–∞—Ç–∞ —Ä–∞—Å—á–µ—Ç–∞ (—Ç—Ä–∞–Ω–∑–∏—Ç):</td>
                    <td>
                        <div class="row">
                            <input type="number" id="t_day" placeholder="–î–î" min="1" max="31">
                            <select id="t_month">
                                <option value="1">–Ø–Ω–≤–∞—Ä—è</option>
                                <option value="2">–§–µ–≤—Ä–∞–ª—è</option>
                                <option value="3">–ú–∞—Ä—Ç–∞</option>
                                <option value="4">–ê–ø—Ä–µ–ª—è</option>
                                <option value="5">–ú–∞—è</option>
                                <option value="6">–ò—é–Ω—è</option>
                                <option value="7">–ò—é–ª—è</option>
                                <option value="8">–ê–≤–≥—É—Å—Ç–∞</option>
                                <option value="9">–°–µ–Ω—Ç—è–±—Ä—è</option>
                                <option value="10">–û–∫—Ç—è–±—Ä—è</option>
                                <option value="11">–ù–æ—è–±—Ä—è</option>
                                <option value="12">–î–µ–∫–∞–±—Ä—è</option>
                            </select>
                            <span class="separator">,</span>
                            <input type="number" id="t_year" placeholder="–ì–ì–ì–ì" class="year-input" min="1900" max="2100">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>–í—Ä–µ–º—è —Ä–∞—Å—á–µ—Ç–∞:</td>
                    <td>
                        <div class="row">
                            <input type="number" id="t_hour" placeholder="–ß–ß" min="0" max="23">
                            <span class="separator">:</span>
                            <input type="number" id="t_minute" placeholder="–ú–ú" min="0" max="59">
                        </div>
                    </td>
                </tr>
            </table>

            <button class="calc-btn" id="calcBtn" onclick="calculate()">–†–ê–°–°–ß–ò–¢–ê–¢–¨ –¢–†–ê–ù–ó–ò–¢–´</button>
            <div id="errorMsg" class="error-msg"></div>
        </div>

        <!-- RESULTS -->
        <div id="result" class="result-section">
            <!-- Mode Tabs: –ù–∞—Ç–∞–ª / –°–æ–ª—è—Ä / –õ—É–Ω–∞—Ä -->
            <div class="mode-tabs">
                <button class="mode-tab active" data-mode="natal" onclick="setMode('natal')">–ù–∞—Ç–∞–ª</button>
                <button class="mode-tab" data-mode="solar" onclick="setMode('solar')">–°–æ–ª—è—Ä</button>
                <button class="mode-tab" data-mode="lunar" onclick="setMode('lunar')">–õ—É–Ω–∞—Ä</button>
            </div>

            <!-- Extra settings for Solar/Lunar -->
            <div id="solarSettings" class="extra-settings">
                <h4>‚òÄÔ∏è –°–æ–ª—è—Ä ‚Äî —É–∫–∞–∂–∏—Ç–µ –≥–æ–¥</h4>
                <div class="row">
                    <span>–ì–æ–¥ —Å–æ–ª—è—Ä–∞:</span>
                    <input type="number" id="solar_year" style="width:100px">
                    <button onclick="calculateSolar()" style="padding:8px 15px; background:var(--blue); border:none; color:white; border-radius:5px; cursor:pointer;">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–æ–ª—è—Ä</button>
                </div>
            </div>
            <div id="lunarSettings" class="extra-settings">
                <h4>üåô –õ—É–Ω–∞—Ä ‚Äî —É–∫–∞–∂–∏—Ç–µ –º–µ—Å—è—Ü</h4>
                <div class="row">
                    <span>–ú–µ—Å—è—Ü:</span>
                    <input type="number" id="lunar_month" style="width:60px" placeholder="–ú–ú">
                    <input type="number" id="lunar_year" style="width:100px" placeholder="–ì–ì–ì–ì">
                    <button onclick="calculateLunar()" style="padding:8px 15px; background:var(--blue); border:none; color:white; border-radius:5px; cursor:pointer;">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ª—É–Ω–∞—Ä</button>
                </div>
            </div>

            <h2 style="text-align:center">
                <span id="resName" style="color: var(--accent)"></span> ‚Äî —Ä–∞—Å—á–µ—Ç –¢—Ä–∞–Ω–∑–∏—Ç–æ–≤
            </h2>
            <div style="text-align: center; color: #888; font-size: 14px; margin-bottom: 10px;">
                <div>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è: <span id="resBirth"></span></div>
                <div>–ú–µ—Å—Ç–æ: <span id="resCity"></span></div>
                <div id="resTransit" style="color: var(--blue);"></div>
            </div>

            <!-- View Tabs: –ù–∞—Ç–∞–ª—å–Ω—ã–µ / –¢—Ä–∞–Ω–∑–∏—Ç—ã -->
            <div class="view-tabs" id="viewTabs">
                <button class="view-tab active" data-view="natal" onclick="setView('natal')">–ù–∞—Ç–∞–ª—å–Ω—ã–µ</button>
                <button class="view-tab" data-view="transit" onclick="setView('transit')">–¢—Ä–∞–Ω–∑–∏—Ç—ã</button>
            </div>

            <!-- Chart -->
            <div id="chartDiv"></div>

            <!-- Matrix & Tables -->
            <div class="scheme-box">
                <h3 style="text-align:center; margin-top:0">‚ú® <span id="matrixTitle">–ú–∞—Ç—Ä–∏—Ü–∞ –∞—Å–ø–µ–∫—Ç–æ–≤</span></h3>
                <div class="aspect-matrix-wrapper">
                    <table id="aspectMatrixTable" class="aspect-matrix-table"></table>
                </div>
                <div id="transitMeta" class="info-text"></div>
                <div class="aspect-legend">
                    <div class="aspect-legend-item"><span class="legend-symbol asp-conj">‚óè</span>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ 0¬∞</div>
                    <div class="aspect-legend-item"><span class="legend-symbol asp-sextile">‚ú∂</span>–°–µ–∫—Å—Ç–∏–ª—å 60¬∞</div>
                    <div class="aspect-legend-item"><span class="legend-symbol asp-trine">‚ñ≥</span>–¢—Ä–∏–≥–æ–Ω 120¬∞</div>
                    <div class="aspect-legend-item"><span class="legend-symbol asp-square">‚ñ°</span>–ö–≤–∞–¥—Ä–∞—Ç 90¬∞</div>
                    <div class="aspect-legend-item"><span class="legend-symbol asp-opposition">‚òç</span>–û–ø–ø–æ–∑–∏—Ü–∏—è 180¬∞</div>
                    <div class="aspect-legend-item"><span style="color:#ff5555">R</span>–†–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω—ã–π</div>
                </div>
            </div>

            <div class="scheme-box">
                <h3 style="text-align:center; margin-top:0">ü™ê –ü–ª–∞–Ω–µ—Ç—ã</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>–ü–ª–∞–Ω–µ—Ç–∞</th>
                            <th>–ù–∞—Ç–∞–ª—å–Ω–∞—è –¥–æ–ª–≥–æ—Ç–∞</th>
                            <th>–î–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ</th>
                            <th id="transitColHeader">–¢—Ä–∞–Ω–∑–∏—Ç–Ω–∞—è –¥–æ–ª–≥–æ—Ç–∞</th>
                        </tr>
                    </thead>
                    <tbody id="planetsTableBody"></tbody>
                </table>
            </div>

            <!-- Texts -->
            <div class="text-section">
                <h3 style="text-align:center">üìñ –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</h3>
                <div id="textsList"></div>
            </div>

            <button onclick="downloadPDF()" style="display:block; width:100%; max-width:300px; margin:30px auto; padding:15px; background:#444; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
                üìÑ –°–∫–∞—á–∞—Ç—å PDF –æ—Ç—á–µ—Ç
            </button>
            
            <button onclick="goBack()" style="display:block; width:100%; max-width:300px; margin:10px auto 50px; padding:12px; background:transparent; color:var(--blue); border:1px solid var(--blue); border-radius:8px; font-size:14px; cursor:pointer;">
                ‚Üê –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            </button>
        </div>
    </div>

    <script>
        let currentMode = 'natal';
        let currentView = 'natal';
        let globalData = null;
        let birthData = {};


        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –ø–æ–ª—è–º–∏
        function setupAutoFocus() {
            const fieldGroups = [
                ['day', 'month', 'year', 'hour', 'minute', 'city'],
                ['t_day', 't_month', 't_year', 't_hour', 't_minute']
            ];
            
            fieldGroups.forEach(group => {
                group.forEach((fieldId, index) => {
                    const field = document.getElementById(fieldId);
                    if (!field) return;
                    
                    if (field.tagName === 'INPUT' && field.type === 'number') {
                        field.addEventListener('input', function() {
                            const maxLen = this.placeholder === '–ì–ì–ì–ì' ? 4 : 2;
                            if (this.value.length >= maxLen && index < group.length - 1) {
                                const nextField = document.getElementById(group[index + 1]);
                                if (nextField) nextField.focus();
                            }
                        });
                    }
                    
                    if (field.tagName === 'SELECT') {
                        field.addEventListener('change', function() {
                            if (index < group.length - 1) {
                                const nextField = document.getElementById(group[index + 1]);
                                if (nextField) nextField.focus();
                            }
                        });
                    }
                });
            });
        }

        // Init
        window.addEventListener('load', () => {
            setDefaultDates();
            setupAutoFocus();
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
        });

        function setDefaultDates() {
            const now = new Date();
            document.getElementById('t_day').value = now.getDate();
            document.getElementById('t_month').value = now.getMonth() + 1;
            document.getElementById('t_year').value = now.getFullYear();
            document.getElementById('t_hour').value = now.getHours();
            document.getElementById('t_minute').value = now.getMinutes();
        }

        // City search - –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ + API fallback
        let localCities = [];
        let abortController = null;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        fetch('/static/cities.json').then(r => r.json()).then(data => { localCities = data; });
        
        function suggestCity() {
            const val = document.getElementById('city').value.trim().toLowerCase();
            const list = document.getElementById('suggestions');
            if(val.length < 1) { list.style.display='none'; return; }
            
            // –ò—â–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ)
            const local = localCities.filter(c => 
                c.name.toLowerCase().startsWith(val) || 
                c.name.toLowerCase().includes(val)
            ).slice(0, 6);
            
            if (local.length > 0) {
                renderLocalCities(local, list);
            } else if (val.length >= 3) {
                // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ - –∏–¥—ë–º –≤ API
                searchOnline(val, list);
            } else {
                list.style.display = 'none';
            }
        }
        
        function renderLocalCities(cities, list) {
            list.innerHTML = '';
            list.style.display = 'block';
            cities.forEach(c => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = `${c.name}, ${c.region}`;
                div.onclick = () => selectCity(c.name, c.lat, c.lon);
                list.appendChild(div);
            });
        }
        
        async function searchOnline(val, list) {
            if (abortController) abortController.abort();
            abortController = new AbortController();
            try {
                const res = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&accept_language=ru&addressdetails=1&limit=6`,
                    { signal: abortController.signal }
                );
                const data = await res.json();
                renderOnlineCities(data, list);
            } catch(e) { if (e.name !== 'AbortError') console.error(e); }
        }
        
        function renderOnlineCities(data, list) {
            list.innerHTML = '';
            if (!data.length) { list.style.display='none'; return; }
            list.style.display = 'block';
            const seen = new Set();
            data.forEach(p => {
                const cityName = p.address?.city || p.address?.town || p.address?.village || p.display_name.split(',')[0];
                const country = p.address?.country || '';
                const uniqueKey = cityName + '_' + String(p.lat).substring(0,5);
                if (seen.has(uniqueKey)) return;
                seen.add(uniqueKey);
                if (seen.size > 5) return;
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = `${cityName}, ${country}`;
                div.onclick = () => selectCity(cityName, p.lat, p.lon);
                list.appendChild(div);
            });
        }
        
        function selectCity(name, lat, lon) {
            document.getElementById('city').value = name;
            document.getElementById('lat').value = lat;
            document.getElementById('lon').value = lon;
            document.getElementById('coordsDisplay').textContent = `–®–∏—Ä–æ—Ç–∞: ${parseFloat(lat).toFixed(4)}, –î–æ–ª–≥–æ—Ç–∞: ${parseFloat(lon).toFixed(4)}`;
            document.getElementById('suggestions').style.display = 'none';
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-group')) {
                document.querySelectorAll('.suggestions').forEach(s => s.style.display = 'none');
            }
        });

        // Calculate
        async function calculate() {
            const btn = document.getElementById('calcBtn');
            const errorDiv = document.getElementById('errorMsg');
            
            // Validate
            const fields = ['day', 'month', 'year', 'hour', 'minute', 'city', 't_day', 't_month', 't_year', 't_hour', 't_minute'];
            for (let id of fields) {
                if (!document.getElementById(id).value) {
                    errorDiv.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
                    errorDiv.style.display = 'block';
                    return;
                }
            }
            
            btn.innerHTML = "‚è≥ –í—ã—á–∏—Å–ª—è—é...";
            btn.disabled = true;
            errorDiv.style.display = 'none';

            const genderRadio = document.querySelector('input[name="gender"]:checked');
            birthData = {
                name: document.getElementById('name').value || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                gender: genderRadio ? genderRadio.value : "male",
                year: parseInt(document.getElementById('year').value),
                month: parseInt(document.getElementById('month').value),
                day: parseInt(document.getElementById('day').value),
                hour: parseInt(document.getElementById('hour').value),
                minute: parseInt(document.getElementById('minute').value),
                city: document.getElementById('city').value,
                lat: parseFloat(document.getElementById('lat').value) || null,
                lon: parseFloat(document.getElementById('lon').value) || null,
                mode: 'natal',
                transit_year: parseInt(document.getElementById('t_year').value),
                transit_month: parseInt(document.getElementById('t_month').value),
                transit_day: parseInt(document.getElementById('t_day').value),
                transit_hour: parseInt(document.getElementById('t_hour').value),
                transit_minute: parseInt(document.getElementById('t_minute').value)
            };

            try {
                const res = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(birthData)
                });
                const result = await res.json();
                
                if (result.error) throw new Error(result.error);

                globalData = result;
                
                // Set solar/lunar defaults
                document.getElementById('solar_year').value = new Date().getFullYear();
                document.getElementById('lunar_month').value = new Date().getMonth() + 1;
                document.getElementById('lunar_year').value = new Date().getFullYear();
                
                renderResult(result);
                document.getElementById('inputForm').style.display = 'none';
                document.getElementById('result').style.display = 'block';
                window.scrollTo({top: 0, behavior: 'smooth'});
            } catch (e) {
                errorDiv.textContent = "–û—à–∏–±–∫–∞: " + e.message;
                errorDiv.style.display = 'block';
            } finally {
                btn.innerHTML = "–†–ê–°–°–ß–ò–¢–ê–¢–¨ –¢–†–ê–ù–ó–ò–¢–´";
                btn.disabled = false;
            }
        }

        function goBack() {
            document.getElementById('result').style.display = 'none';
            document.getElementById('inputForm').style.display = 'block';
        }

        // Mode switching
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.mode-tab[data-mode="${mode}"]`).classList.add('active');
            
            document.getElementById('solarSettings').classList.toggle('visible', mode === 'solar');
            document.getElementById('lunarSettings').classList.toggle('visible', mode === 'lunar');
            
            if (mode === 'natal' && globalData) {
                updateDisplay();
            }
        }

        async function calculateSolar() {
            const year = parseInt(document.getElementById('solar_year').value);
            if (!year) return alert('–£–∫–∞–∂–∏—Ç–µ –≥–æ–¥');
            
            const data = {...birthData, mode: 'solar', solar_year: year};
            const res = await fetch('/api/calculate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.error) return alert(result.error);
            globalData = result;
            updateDisplay();
        }

        async function calculateLunar() {
            const month = parseInt(document.getElementById('lunar_month').value);
            const year = parseInt(document.getElementById('lunar_year').value);
            if (!month || !year) return alert('–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—è—Ü –∏ –≥–æ–¥');
            
            const data = {...birthData, mode: 'lunar', lunar_month: month, lunar_year: year};
            const res = await fetch('/api/calculate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if (result.error) return alert(result.error);
            globalData = result;
            updateDisplay();
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.view-tab[data-view="${view}"]`).classList.add('active');
            updateDisplay();
        }

        function updateDisplay() {
            const data = globalData;
            if (!data) return;
            
            const matrixTitle = document.getElementById('matrixTitle');
            const transitMeta = document.getElementById('transitMeta');
            
            if (currentView === 'natal') {
                matrixTitle.textContent = '–ù–∞—Ç–∞–ª—å–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã';
                transitMeta.textContent = '';
                renderAspectMatrix(data.planets, data.planets, data.aspects, false);
                drawChart(data.planets, data.houses, data.aspects, null);
            } else {
                const transit = data.transit_planets || [];
                const aspects = data.transit_aspects || data.aspects || [];
                matrixTitle.textContent = currentMode === 'natal' ? '–¢—Ä–∞–Ω–∑–∏—Ç ‚Üî –ù–∞—Ç–∞–ª' :
                                          currentMode === 'solar' ? '–°–æ–ª—è—Ä ‚Üî –ù–∞—Ç–∞–ª' : '–õ—É–Ω–∞—Ä ‚Üî –ù–∞—Ç–∞–ª';
                const meta = data.transit_meta || data.transit_meta;
                transitMeta.textContent = meta ? `–ù–∞ ${meta.dt}` : '';
                if (transit.length > 0) {
                    renderAspectMatrix(data.planets, transit, aspects, true);
                } else {
                    renderAspectMatrix(data.planets, data.planets, data.aspects, false);
                }
                drawChart(data.planets, data.houses, data.aspects, transit.length > 0 ? transit : null);
            }
        }

        function renderResult(data) {
            document.getElementById('resName').textContent = data.name;
            document.getElementById('resBirth').textContent = data.meta.dt;
            document.getElementById('resCity').textContent = data.meta.city;
            
            if (data.transit_meta) {
                document.getElementById('resTransit').textContent = `–¢—Ä–∞–Ω–∑–∏—Ç—ã –Ω–∞: ${data.transit_meta.dt}`;
            }
            
            renderPlanetsTable(data);
            renderTexts(data);
            
            currentView = 'transit';  // Start with transit view
            document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.view-tab[data-view="transit"]').classList.add('active');
            updateDisplay();
        }

        function renderPlanetsTable(data) {
            const tBody = document.getElementById('planetsTableBody');
            tBody.innerHTML = '';
            const transit = data.transit_planets || [];
            const transitMap = {};
            transit.forEach(p => { if (p.key) transitMap[p.key] = p; });

            const formatPos = (p) => {
                if (!p) return '‚Äî';
                const degree = p.degree || p.pos || 0;
                const deg = Math.floor(degree);
                const min = Math.round((degree % 1) * 60);
                return `${p.sign} ${deg}¬∞${min.toString().padStart(2,'0')}'`;
            };

            data.planets.forEach(p => {
                const retro = p.is_retro ? '<span style="color:#ff5555">R</span>' : '';
                const op = transitMap[p.key];
                const oRetro = op?.is_retro ? '<span style="color:#ff5555">R</span>' : '';
                tBody.innerHTML += `<tr>
                    <td>${p.icon} ${p.name} ${retro}</td>
                    <td>${formatPos(p)}</td>
                    <td>${p.dignity ? '<span style="color:' + (p.dignity=="–û–±–∏—Ç–µ–ª—å"?'#4caf50':p.dignity=="–≠–∫–∑–∞–ª—å—Ç–∞—Ü–∏—è"?'#8bc34a':p.dignity=="–ò–∑–≥–Ω–∞–Ω–∏–µ"?'#f44336':'#ff9800') + '; font-weight:bold;">' + p.dignity + '</span>' : '‚Äî'}</td>
                    <td class="transit-cell">${op ? formatPos(op) + oRetro : '‚Äî'}</td>
                </tr>`;
            });
        }

        function renderTexts(data) {
            const container = document.getElementById('textsList');
            container.innerHTML = '';
            
            data.planets.forEach(p => {
                if (p.text && p.key !== 'ASC' && p.key !== 'MC') {
                    container.innerHTML += `<div class="planet-text-block">
                        <div class="planet-text-header">${p.icon} ${p.name} –≤ ${p.sign}, ${p.house} –¥–æ–º</div>
                        <div class="planet-text-body">${p.text}</div>
                    </div>`;
                }
            });

            const colors = {Square:'#ff5555', Opposition:'#ff5555', Trine:'#8bc34a', Sextile:'#4dd0e1', Conjunction:'#4fc3f7'};
            const symbols = {Conjunction:'‚òå', Sextile:'‚ú∂', Square:'‚ñ°', Trine:'‚ñ≥', Opposition:'‚òç', Quincunx:'‚§ª'};
            
            data.aspects.forEach(a => {
                container.innerHTML += `<div class="planet-text-block" style="border-left-color:${colors[a.type]||'#ccc'}">
                    <div class="planet-text-header"><span style="color:${colors[a.type]||'#ccc'}">${symbols[a.type]||'‚óè'}</span> ${a.p1} ‚Äî ${a.p2} (${a.name || a.type})</div>
                    <div class="planet-text-body">${a.text || ''}</div>
                </div>`;
            });
        }

        function drawChart(planets, cusps, aspects, transit) {
            const container = document.getElementById('chartDiv');
            const size = Math.min(container.clientWidth, 650) || 500;
            container.style.height = size + 'px';
            const chart = new NatalChart('chartDiv', size);
            chart.draw({planets, houses: cusps, aspects, outerPlanets: transit});
        }

        function renderAspectMatrix(natal, transit, aspects, isTransit) {
            const table = document.getElementById('aspectMatrixTable');
            table.innerHTML = '';
            
            const order = [
                {key:'Sun',icon:'‚òâ'},{key:'Moon',icon:'‚òæ'},{key:'Mercury',icon:'‚òø'},{key:'Venus',icon:'‚ôÄ'},
                {key:'Mars',icon:'‚ôÇ'},{key:'Jupiter',icon:'‚ôÉ'},{key:'Saturn',icon:'‚ôÑ'},{key:'Uranus',icon:'‚ôÖ'},
                {key:'Neptune',icon:'‚ôÜ'},{key:'Pluto',icon:'‚ôá'},{key:'Lilith',icon:'‚ö∏'},
                {key:'North_node',icon:'‚òä'},{key:'ASC',icon:'AC'},{key:'MC',icon:'MC'}
            ];
            
            const natalMap = {}, transitMap = {}, aspectMap = {};
            natal.forEach(p => { if(p.key) natalMap[p.key]=p; });
            transit.forEach(p => { if(p.key) transitMap[p.key]=p; });
            aspects.forEach(a => {
                if(a.p1_key && a.p2_key) {
                    aspectMap[`${a.p1_key}_${a.p2_key}`] = a;
                    aspectMap[`${a.p2_key}_${a.p1_key}`] = a;
                }
            });
            
            const sym = {
                Conjunction:{c:'‚óè',cls:'asp-conj'}, Sextile:{c:'‚ú∂',cls:'asp-sextile'},
                Square:{c:'‚ñ°',cls:'asp-square'}, Trine:{c:'‚ñ≥',cls:'asp-trine'},
                Opposition:{c:'‚òç',cls:'asp-opposition'}, Quincunx:{c:'‚§ª',cls:'asp-quincunx'}
            };

            const header = document.createElement('tr');
            header.innerHTML = '<th>‚Üì/‚Üí</th>' + order.map(p => `<th><span class="matrix-icon">${p.icon}</span></th>`).join('');
            table.appendChild(header);

            order.forEach((rowP, ri) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<th><span class="matrix-icon">${rowP.icon}</span></th>`;
                order.forEach((colP, ci) => {
                    const td = document.createElement('td');
                    if (!isTransit && ci >= ri) {
                        td.classList.add('matrix-empty');
                    } else {
                        const key = `${rowP.key}_${colP.key}`;
                        const asp = aspectMap[key];
                        if (asp) {
                            const s = sym[asp.type] || sym.Conjunction;
                            td.innerHTML = `<span class="matrix-symbol ${s.cls}">${s.c}</span>`;
                            td.title = `${asp.p1} ${asp.name} ${asp.p2} (${asp.orb}¬∞)`;
                        } else {
                            td.classList.add('matrix-empty');
                        }
                    }
                    tr.appendChild(td);
                });
                table.appendChild(tr);
            });
        }

        function downloadPDF() {
            const name = birthData.name || 'report';
            const link = document.createElement('a');
            link.href = `/api/pdf?name=${encodeURIComponent(name)}`;
            link.download = `Transit_${name}.pdf`;
            link.click();
        }
    </script>
</body>
</html>
