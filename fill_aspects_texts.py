import json
import os
from pathlib import Path

"""
Скрипт для заполнения раздела `aspects` в texts.json
более глубокими и живыми интерпретациями.

Логика:
- Берём все пары планет из data["aspects"].
- Для каждой пары и каждого аспекта (Соединение, Секстиль, Квадрат, Тригон, Оппозиция)
  генерируем текст по шаблону, учитывая архетипы планет и природу аспекта.

Запуск:
    cd "Натальная карта"
    python3 fill_aspects_texts.py
"""

BASE_DIR = Path(__file__).parent
TEXTS_FILE = BASE_DIR / "texts.json"


def load_texts() -> dict:
    if TEXTS_FILE.exists():
        with open(TEXTS_FILE, "r", encoding="utf-8") as f:
            return json.load(f)
    return {}


def save_texts(data: dict):
    with open(TEXTS_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)


# Отображение "сырых" ключей в читабельные имена
BODY_NAME_MAP = {
    # английские ключи
    "Sun": "Солнце",
    "Moon": "Луна",
    "Mercury": "Меркурий",
    "Venus": "Венера",
    "Mars": "Марс",
    "Jupiter": "Юпитер",
    "Saturn": "Сатурн",
    "Uranus": "Уран",
    "Neptune": "Нептун",
    "Pluto": "Плутон",
    "Lilith": "Лилит",
    "North_node": "Северный узел",
    "South_node": "Южный узел",
    # русские варианты, которые уже есть в texts.json
    "Солнце": "Солнце",
    "Луна": "Луна",
    "Меркурий": "Меркурий",
    "Венера": "Венера",
    "Марс": "Марс",
    "Юпитер": "Юпитер",
    "Сатурн": "Сатурн",
    "Уран": "Уран",
    "Нептун": "Нептун",
    "Плутон": "Плутон",
    "Лилит": "Лилит",
    "Сев_Узел": "Северный узел",
    "Юж_Узел": "Южный узел",
}


PLANET_ARCHETYPES = {
    "Солнце": "ваше ядро, чувство «я» и жизненная воля",
    "Луна": "эмоции, тонкую чувствительность и потребность в безопасности",
    "Меркурий": "мышление, речь, любопытство и способность договариваться",
    "Венера": "сердце, вкус к жизни, любовь и умение притягивать красоту",
    "Марс": "волю, силу желания, импульсивность и готовность действовать",
    "Юпитер": "веру в смысл, чувство расширения, удачу и жизненную философию",
    "Сатурн": "внутренний взрослый голос, границы, страхи и чувство долга",
    "Уран": "порыв к свободе, уникальность, внезапные прозрения и бунт",
    "Нептун": "мечты, тонкую интуицию, мистический опыт и склонность идеализировать",
    "Плутон": "глубинную силу, трансформацию, кризисы и внутреннюю магию",
    "Лилит": "теневые желания, табу, тему соблазна и то, что вы стараетесь скрыть даже от себя",
    "Северный узел": "вектор роста души, направление, куда вам важно смело идти",
    "Южный узел": "накопленный опыт прошлых жизней и привычные сценарии, от которых пора мягко отпускать привязку",
}


def split_pair_key(pair: str) -> tuple[str, str]:
    """
    Разбираем ключ пары, учитывая специальные случаи типа Венера_Сев_Узел, North_node_Lilith и т.п.
    """
    specials = ["North_node", "South_node", "Сев_Узел", "Юж_Узел"]
    for sp in specials:
        prefix = sp + "_"
        suffix = "_" + sp
        if pair.startswith(prefix):
            return sp, pair[len(prefix):]
        if pair.endswith(suffix):
            return pair[: -len(suffix)], sp
    # по умолчанию — делим по первому подчёркиванию
    if "_" in pair:
        left, right = pair.split("_", 1)
        return left, right
    # на всякий случай
    return pair, pair


def get_body_display_name(raw: str) -> str:
    return BODY_NAME_MAP.get(raw, raw)


def make_aspect_text(p1: str, p2: str, aspect: str) -> str:
    """
    Генерируем текст для конкретного аспекта между двумя объектами.
    p1, p2 — уже человекочитаемые имена (Солнце, Луна, Северный узел...).
    aspect — одно из: Соединение, Секстиль, Квадрат, Тригон, Оппозиция.
    """
    a1 = PLANET_ARCHETYPES.get(p1, f"энергию {p1}")
    a2 = PLANET_ARCHETYPES.get(p2, f"энергию {p2}")

    intro = f"Аспект {aspect} между {p1} и {p2} соединяет {a1} и {a2} в один внутренний сюжет вашей жизни."

    if aspect == "Соединение":
        body = (
            f" Их голоса звучат почти как один, поэтому вы часто переживаете темы этих планет особенно остро. "
            f"Такое соединение даёт ощущение судьбоносности: нельзя просто «отодвинуть» эти качества в сторону, "
            f"они требуют осознанного принятия. Чем честнее вы смотрите на свои желания и страхи, тем гармоничнее "
            f"раскрывается потенциал этого аспекта."
        )
    elif aspect == "Секстиль":
        body = (
            f" Это мягкая, но очень ценная поддержка: жизнь словно подбрасывает вам ситуации, где {p1.lower()} и {p2.lower()} "
            f"могут сотрудничать. Секстиль не кричит — он действует как приглашение, которое нужно заметить и принять. "
            f"Если вы проявляете инициативу, таланты по этому аспекту начинают работать как лёгкая удача и приятные совпадения."
        )
    elif aspect == "Тригон":
        body = (
            f" Тригон даёт ощущение естественного потока: качества {p1} и {p2} проявляются легко, без лишнего напряжения. "
            f"Часто это врождённый дар или благословение, которым вы можете пользоваться как чем-то само собой разумеющимся. "
            f"Главная задача — не растрачивать этот потенциал впустую, а направлять его туда, где он действительно важен для вашей души."
        )
    elif aspect == "Квадрат":
        body = (
            f" Квадрат обнажает противоречия между тем, как вы проживаете {p1.lower()}, и тем, как раскрывается {p2.lower()}. "
            f"Здесь возможны внутренние конфликты, кризисы и ситуации выбора, когда приходится выходить из зоны комфорта. "
            f"Но именно через такие острые моменты вы растёте, учитесь брать ответственность и находить форму, в которой обе планеты "
            f"могут быть услышаны без самоуничтожения."
        )
    elif aspect == "Оппозиция":
        body = (
            f" Оппозиция часто проявляется через других людей: партнёров, окружение, важные фигуры вашей жизни. "
            f"Через них вы видите ту часть себя, которую сначала легче проецировать наружу, чем признать внутри. "
            f"Баланс между полюсами {p1} и {p2} приходит не через отказ от чего-то одного, а через уважение к обеим энергиям "
            f"и умение выстраивать зрелые отношения — и с собой, и с миром."
        )
    else:
        body = (
            f" Этот аспект подчёркивает особую связь между {p1} и {p2}, создавая ситуации, в которых их темы выходят на первый план. "
            f"То, как вы проживаете эту связь, зависит от уровня осознанности: через автоматические реакции она приносит напряжение, "
            f"через честный диалог с собой — глубокое ощущение смысла и внутренней силы."
        )

    closing = (
        " Этот аспект не делает вас «хорошим» или «плохим» — он просто показывает, где ваша живая энергия особенно ярко звучит "
        "и где душа просит о внимательном, бережном отношении к себе."
    )

    return intro + " " + body + " " + closing


def main():
    data = load_texts()
    aspects = data.get("aspects", {})
    if not aspects:
        print("В texts.json нет раздела 'aspects'. Нечего заполнять.")
        return

    updated = 0
    for pair_key, amap in aspects.items():
        raw1, raw2 = split_pair_key(pair_key)
        p1 = get_body_display_name(raw1)
        p2 = get_body_display_name(raw2)

        for aspect_name in ["Соединение", "Секстиль", "Квадрат", "Тригон", "Оппозиция"]:
            text = make_aspect_text(p1, p2, aspect_name)
            amap[aspect_name] = text
            updated += 1

    data["aspects"] = aspects
    save_texts(data)
    print(f"✅ Обновлены тексты аспектов. Всего записано {updated} интерпретаций.")


if __name__ == "__main__":
    main()


